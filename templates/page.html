<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Discussion Guide — Rooms</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#0e0f12; --panel:#161820; --card:#1e2230; --text:#e8ecf3;
      --muted:#9aa3b2; --accent:#7aa2ff; --border:#2a2f3c; --danger:#ff6b6b;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:28px auto 80px;padding:0 16px;}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
    header h1{font-size:20px;margin:0 12px 0 0;font-weight:700;}
    .bar{background:var(--panel);border:1px solid var(--border);border-radius:12px;
      padding:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    input[type="text"],select{background:#0f1117;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:8px 10px;outline:none;min-width:180px;}
    button{background:var(--accent);color:#0a0b0f;border:none;border-radius:10px;padding:9px 12px;
      font-weight:700;cursor:pointer;}
    button.secondary{background:#2b3040;color:var(--text);}
    button.danger{background:var(--danger);color:#101114;}
    .muted{color:var(--muted);} .spacer{flex:1}
    .board{display:block;margin-top:8px;}
    .card{width:100%;box-sizing:border-box;margin:12px 0;background:var(--card);
      border:1px solid var(--border);border-radius:16px;}
    .card-header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);}
    .drag-handle{cursor:grab;user-select:none;font-weight:900;letter-spacing:1px;opacity:.7;}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#2b3142;color:#cfe;}
    .card-body{padding:12px;white-space:pre-wrap;}
    .ghost{opacity:.5;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .row>*{flex:0 0 auto;} .row .grow{flex:1 1 240px;min-width:240px;}
    .hint{margin-top:8px;} .footer{margin-top:18px;color:var(--muted);font-size:13px;}

    /* three lanes */
    .boards {
      display: grid;
      grid-template-columns: 1fr;   /* always one column */
      gap: 14px;
      margin-top: 12px;
    }
    .board-wrap { background: transparent; }
    .board-title { font-weight: 700; color: var(--muted); margin: 4px 0 2px; }
    .board-muted .card { opacity: .95; }
    .board-muted .drag-handle { opacity: .35; cursor: default; }

    /* compact icon buttons */
    .icon-btn {
      background: transparent; color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 4px 8px; line-height: 1; display: inline-flex; align-items: center;
    }
    .icon-btn:hover { opacity: .9; }
    .icon-btn.danger { border-color: #4d2630; }
    .icon-btn svg { width: 16px; height: 16px; display: block; }

    /* "Open PDF" anchor should look like button and not purple when visited */
    #pdfLink, #pdfLink:link, #pdfLink:visited {
      color: var(--text);
      background: #2b3040;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px 12px;
      display: inline-block;
      text-decoration: none;
    }
    #pdfLink:hover { opacity: .9; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Discussion Guide</h1>
      <span class="muted">live shared rooms</span>
    </header>

    <!-- Room + actions bar -->
    <div class="bar">
      <select id="roomSelect" title="Rooms"></select>
      <input id="roomInput" type="text" placeholder="New room name…" />
      <button id="createJoinBtn">Create / Join</button>
      <button id="shareBtn" class="secondary">Copy Share Link</button>

      <a id="pdfLink" href="#" target="_blank" rel="noopener" style="display:none">Open PDF</a>

      <div class="spacer"></div>
      <button id="loadLatestBtn" class="secondary" title="Load from data/guide.json">Load Latest Sermon</button>
      <button id="refreshBtn" class="secondary" title="Re-read data/guide.json with no cache">Refresh</button>
      <button id="deleteRoomBtn" class="danger" title="Delete this room for everyone">Delete Room</button>
      <span class="muted" id="status"></span>
    </div>

    <!-- Add new card -->
    <div class="bar" style="margin-top:10px">
      <select id="newType">
        <option value="question">Question</option>
        <option value="section">Section</option>
      </select>
      <input id="newTitle" type="text" placeholder="(optional) Title for section" />
      <input id="newText" class="grow" type="text" placeholder="Type your question/section text…" />
      <button id="addBtn">Add</button>
    </div>

    <!-- Boards -->
    <div class="boards">
      <div class="board-wrap">
        <div class="board-title">Active</div>
        <div id="boardActive" class="board"></div>
      </div>
      <div class="board-wrap">
        <div class="board-title">Completed</div>
        <div id="boardDone" class="board board-muted"></div>
      </div>
      <div class="board-wrap">
        <div class="board-title">Deleted</div>
        <div id="boardDeleted" class="board board-muted"></div>
      </div>
    </div>

    <div class="hint muted">Rooms are live: edits autosave & sync to others in the same room.</div>
    <div class="footer">Loads from <code>data/guide.json</code> by default.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" crossorigin="anonymous"></script>

  <script type="module">
    import { connectFirebase, joinRoom, saveLive, loadLive, listRooms, currentRoomCode, deleteRoom } from "./static/js/viewStore.js";

    // ---- Firebase (paste your config) ----
    const FIREBASE_ENABLED = true;
    const firebaseConfig = {
      apiKey: "AIzaSyBMtVbKp6i5cnb_Zapc_sEW8rMebVjuIKs",
      authDomain: "blackhawk-discussion-guide.firebaseapp.com",
      projectId: "blackhawk-discussion-guide",
    };
    if (FIREBASE_ENABLED) { await connectFirebase(firebaseConfig); }

    // ---- DOM ----
    const $roomSel = document.getElementById("roomSelect");
    const $roomInp = document.getElementById("roomInput");
    const $createJoin = document.getElementById("createJoinBtn");
    const $share = document.getElementById("shareBtn");
    const $status = document.getElementById("status");
    const $pdfLink = document.getElementById("pdfLink");

    const $boardActive  = document.getElementById("boardActive");
    const $boardDone    = document.getElementById("boardDone");
    const $boardDeleted = document.getElementById("boardDeleted");
    const $boards       = document.querySelector(".boards");

    const $addBtn = document.getElementById("addBtn");
    const $newType = document.getElementById("newType");
    const $newTitle= document.getElementById("newTitle");
    const $newText = document.getElementById("newText");

    const $deleteRoom = document.getElementById("deleteRoomBtn");
    const $loadLatest = document.getElementById("loadLatestBtn");
    const $refresh = document.getElementById("refreshBtn");

    // ---- Icons (flat SVG) ----
    const ICONS = {
      check: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 6L9 17l-5-5" />
        </svg>`,
      trash: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18" />
          <path d="M8 6V4h8v2" />
          <path d="M19 6l-1 14H6L5 6" />
          <path d="M10 11v6M14 11v6" />
        </svg>`,
      undo: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 9l-4 4 4 4" />
          <path d="M3 13h9a6 6 0 016 6" />
        </svg>`
    };

    // ---- State / render ----
    // cards: [{ id, type, text, title?, status: 'active'|'done'|'deleted' }]
    let cards = [];
    const genId = () => "c_" + Math.random().toString(36).slice(2,9);

    function renderCards(next) {
      // default to active status for any card missing it
      cards = next.map(c => ({ status: 'active', ...c, id: c.id || genId() }));

      $boardActive.innerHTML  = "";
      $boardDone.innerHTML    = "";
      $boardDeleted.innerHTML = "";

      for (const c of cards) {
        const el = document.createElement("div");
        el.className = "card"; el.dataset.id = c.id;

        const header = document.createElement("div");
        header.className = "card-header";
        header.innerHTML = `
          <span class="drag-handle">⋮⋮</span>
          <span class="tag">${c.type === "section" ? "Section" : "Question"}</span>
          ${c.title ? `<strong style="margin-left:6px">${escapeHtml(c.title)}</strong>` : ""}
          <div class="spacer"></div>
          ${c.status === 'active' ? `
            <button class="icon-btn" data-action="complete" title="Mark complete" aria-label="Mark complete">
              ${ICONS.check}
            </button>
            <button class="icon-btn danger" data-action="trash" title="Move to deleted" aria-label="Move to deleted">
              ${ICONS.trash}
            </button>
          ` : `
            <button class="icon-btn" data-action="undo" title="Move back to active" aria-label="Undo">
              ${ICONS.undo}
            </button>
          `}
        `;
        const body = document.createElement("div");
        body.className = "card-body";
        body.textContent = c.text;

        el.appendChild(header);
        el.appendChild(body);

        if (c.status === "done") $boardDone.appendChild(el);
        else if (c.status === "deleted") $boardDeleted.appendChild(el);
        else $boardActive.appendChild(el);
      }
    }

    function getCurrentCards() {
      const byId = Object.fromEntries(cards.map(c => [c.id, c]));
      const read = (container, status) =>
        [...container.querySelectorAll(".card")].map(n => {
          const id = n.dataset.id;
          return { ...byId[id], status };
        });
      return [
        ...read($boardActive,  'active'),
        ...read($boardDone,    'done'),
        ...read($boardDeleted, 'deleted'),
      ];
    }

    // Sortable only on Active column
    Sortable.create($boardActive, {
      animation:150, handle:".drag-handle", ghostClass:"ghost", direction:"vertical",
      onEnd(){ cards=getCurrentCards(); autoSave(); }
    });
    // Done/Deleted columns are read-only

    // Debounced autosave
    const debounce=(fn,ms=400)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const autoSave = debounce(()=>{
      if (!currentRoomCode()) return;
      saveLive(getCurrentCards());
    },400);

    // ✅ Click actions across all three boards
      document.querySelector(".boards").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
      
        const id = btn.closest(".card")?.dataset.id;
        if (!id) return;
      
        const action = btn.dataset.action;
        let newStatus;
        if (action === "complete") newStatus = "done";
        else if (action === "trash") newStatus = "deleted";
        else if (action === "undo") newStatus = "active";
        else return;
      
        // Preserve current order, change only the clicked card’s status
        const current = getCurrentCards();
        const next = current.map(c => (c.id === id ? { ...c, status: newStatus } : c));
      
        renderCards(next);
        autoSave(); // will persist the new board state
      });

    // Add new card -> Active
    document.getElementById("addBtn").addEventListener("click", ()=>{
      const type=$newType.value;
      const title=($newTitle.value||"").trim();
      const text=($newText.value||"").trim();
      if(!text) return;
      const item={ id: genId(), type, text, status:"active" };
      if(type==="section" && title) item.title=title;
      renderCards([...cards, item]);
      $newText.value=""; $newTitle.value="";
      autoSave();
    });

    // Rooms: list, join, share
    async function refreshRoomsList(selected){
      const rooms = await listRooms();
      $roomSel.innerHTML="";
      for(const r of rooms){
        const opt=document.createElement("option"); opt.value=r; opt.textContent=r;
        $roomSel.appendChild(opt);
      }
      if(selected && rooms.includes(selected)) $roomSel.value=selected;
    }

    async function joinAndLoad(room){
      await joinRoom(room, ()=>{
        const state = loadLive();
        renderCards(state);
        $status.textContent = currentRoomCode()
          ? `Connected to room ${currentRoomCode()}`
          : `Local mode (not in a room)`;
      });
      await refreshRoomsList(currentRoomCode());
      const state = loadLive();
      renderCards(state);
    }

    // ?room=CODE
    const urlRoom = new URLSearchParams(location.search).get("room");
    await joinAndLoad(urlRoom || null);
    await refreshRoomsList(currentRoomCode());

    $createJoin.addEventListener("click", async ()=>{
      const name = ($roomInp.value || "").trim();
      if(!name) return;
      await joinAndLoad(name);
      const url = new URL(location.href); url.searchParams.set("room", name);
      history.replaceState(null, "", url.toString());
    });

    $roomSel.addEventListener("change", async ()=>{
      const name=$roomSel.value;
      await joinAndLoad(name);
      const url=new URL(location.href); url.searchParams.set("room", name);
      history.replaceState(null, "", url.toString());
    });

    $share.addEventListener("click", async ()=>{
      const code=currentRoomCode(); if(!code){ alert("Join a room first."); return; }
      const url=new URL(location.href); url.searchParams.set("room", code);
      await navigator.clipboard.writeText(url.toString());
      alert("Share link copied!");
    });

    // Delete Room (with confirm)
    $deleteRoom.addEventListener("click", async () => {
      const code = currentRoomCode();

      if (!code) {
        const ok = confirm(
          "You are not in a room. This will clear ALL local cached rooms on this device. Continue?"
        );
        if (!ok) return;
        localStorage.removeItem("bhq-rooms-v1");
        location.reload();
        return;
      }

      const ok = confirm(
        `Delete room “${code}” for everyone?\n\nThis will remove the live board in Firestore and cannot be undone.`
      );
      if (!ok) return;

      try {
        await deleteRoom(code);
        alert(`Room “${code}” deleted.`);
      } catch (e) {
        console.error(e);
        alert("Failed to delete room (see console).");
      }

      const url = new URL(location.href);
      url.searchParams.delete("room");
      location.href = url.toString();
    });

    // Guide.json loader + PDF link
    const guideJsonUrl=(noCache=false)=>{ const u=new URL("data/guide.json",location.href); if(noCache) u.searchParams.set("ts",Date.now()); return u.toString(); };
    function updateGuideLink(meta){
      const u = (meta && meta.url) ? String(meta.url) : "";
      if (!u) { $pdfLink.style.display = "none"; return; }
      const isPdf = u.toLowerCase().endsWith(".pdf");
      $pdfLink.textContent = isPdf ? "Open PDF" : "Open Source Page";
      $pdfLink.href = u;
      $pdfLink.style.display = "inline-block";
    }
    async function loadGuideJson(noCache=false){
      $status.textContent="Loading…";
      try{
        const res=await fetch(guideJsonUrl(noCache),{cache:noCache?"no-store":"default"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data=await res.json();
        updateGuideLink(data);
        const next=[
          ...(data.questions||[]).map(q=>({type:"question",text:q,status:"active"})),
          ...(data.sections||[]).map(s=>({type:"section",title:s.title,text:s.body,status:"active"}))
        ];
        renderCards(next);
        autoSave(); // persist to room
        $status.textContent=`Loaded: ${next.length} cards`;
      } catch (e) {
        console.error(e);
        $status.textContent="Failed to load data/guide.json";
      }
    }

    // Confirmations for overwriting actions
    $loadLatest.addEventListener("click", () => {
      const ok = confirm(
        "Load Latest Sermon will replace the current board with the latest guide.\n\nAny unsaved changes in this room will be overwritten. Continue?"
      );
      if (!ok) return;
      loadGuideJson(false);
    });
    $refresh.addEventListener("click", () => {
      const ok = confirm(
        "Refresh will re-read the latest guide and overwrite the current board.\n\nAny unsaved changes in this room will be overwritten. Continue?"
      );
      if (!ok) return;
      loadGuideJson(true);
    });

    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  </script>
</body>
</html>
