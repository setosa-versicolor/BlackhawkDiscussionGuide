<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Discussion Guide — Cards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0e0f12;
      --panel: #161820;
      --card: #1e2230;
      --text: #e8ecf3;
      --muted: #9aa3b2;
      --accent: #7aa2ff;
      --border: #2a2f3c;
      --danger: #ff6b6b;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text);
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    a { color: var(--accent); text-decoration: none; }
    .wrap { max-width: 940px; margin: 28px auto 80px; padding: 0 16px; }
    header { display:flex; gap:12px; align-items:center; margin-bottom: 12px; flex-wrap: wrap; }
    header h1 { font-size: 20px; margin:0 12px 0 0; font-weight: 700;}

    .bar, .viewbar { background: var(--panel); border:1px solid var(--border);
      border-radius: 12px; padding: 10px; display:flex; gap:8px; align-items: center; flex-wrap: wrap; }
    input[type="text"], input[type="file"], select, textarea { background:#0f1117; color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:8px 10px; outline:none; min-width: 180px; }
    textarea { width:100%; min-height: 70px; resize: vertical; }
    button { background: var(--accent); color:#0a0b0f; border: none; border-radius: 10px;
      padding: 9px 12px; font-weight: 700; cursor: pointer; }
    button.secondary { background: #2b3040; color: var(--text); }
    button.danger { background: var(--danger); color: #101114; }
    .muted { color: var(--muted); }
    .spacer { flex:1 }

    .board { display: block; margin-top: 16px; }
    .card { width: 100%; box-sizing: border-box; margin: 12px 0; background: var(--card);
      border:1px solid var(--border); border-radius: 16px; }
    .card-header { display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom: 1px solid var(--border); }
    .drag-handle { cursor: grab; user-select:none; font-weight: 900; letter-spacing: 1px; opacity: .7; }
    .tag { font-size: 12px; padding:2px 8px; border-radius: 999px; background:#2b3142; color: #cfe; }
    .card-body { padding:12px; white-space: pre-wrap; }
    .ghost { opacity: .5; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .row > * { flex: 0 0 auto; }
    .row .grow { flex: 1 1 240px; min-width: 240px; }
    .hint { margin-top: 8px; }
    .footer { margin-top: 18px; color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Discussion Guide</h1>
      <span class="muted">interactive cards + shared views</span>
    </header>

    <!-- Source loader (static GitHub Pages) -->
    <div class="bar">
      <button id="loadLatestBtn" title="Load from data/guide.json">Load Latest</button>
      <button id="refreshBtn" class="secondary" title="Re-read data/guide.json with no cache">Refresh</button>
      <div class="spacer"></div>
      <label class="muted">Import JSON: <input id="importFile" type="file" accept="application/json" /></label>
      <button id="exportBtn" class="secondary">Export Current</button>
      <button id="resetBtn" class="danger" title="Clear saved app state">Reset</button>
      <span class="muted" id="status"></span>
    </div>

    <!-- Shared view controls (uses static/js/viewStore.js) -->
    <div class="viewbar" style="margin-top:10px">
      <select id="viewSelect" title="Saved views dropdown"></select>
      <input id="viewName" type="text" placeholder="New view name…" />
      <button id="saveViewBtn">Save / Update</button>
      <div class="spacer"></div>
      <input id="roomCode" type="text" placeholder="Room code (optional for sharing)" />
      <button id="joinRoomBtn">Join</button>
    </div>

    <!-- Add-your-own card -->
    <div class="bar" style="margin-top:10px">
      <select id="newType">
        <option value="question">Question</option>
        <option value="section">Section</option>
      </select>
      <input id="newTitle" type="text" placeholder="(optional) Title for section" />
      <input id="newText" class="grow" type="text" placeholder="Type your question/section text…" />
      <button id="addBtn">Add</button>
    </div>

    <!-- Cards (one per row) -->
    <div id="board" class="board"></div>

    <div class="hint muted">
      Tip: drag cards with the “⋮⋮” handle. Use the dropdown to switch/sync views.
    </div>

    <div class="footer">
      Loads from <code>data/guide.json</code> by default. You can import a different JSON if needed.
    </div>
  </div>

  <!-- SortableJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" integrity="sha256-u3xk3r5U0s4dA7T9Q1rhWlVnA7e9c2b8GQj7iUbk0KU=" crossorigin="anonymous"></script>

  <!-- App -->
  <script type="module">
    // IMPORTANT: this path is relative to your repo structure on GitHub Pages.
    // Keep your shared view store at /static/js/viewStore.js
    import { listViews, loadView, saveView, joinRoom } from "../static/js/viewStore.js";

    // ---------- DOM ----------
    const $board   = document.getElementById("board");
    const $status  = document.getElementById("status");

    const $loadLatest = document.getElementById("loadLatestBtn");
    const $refresh    = document.getElementById("refreshBtn");
    const $reset      = document.getElementById("resetBtn");
    const $importFile = document.getElementById("importFile");
    const $exportBtn  = document.getElementById("exportBtn");

    const $sel     = document.getElementById("viewSelect");
    const $name    = document.getElementById("viewName");
    const $room    = document.getElementById("roomCode");
    const $save    = document.getElementById("saveViewBtn");
    const $join    = document.getElementById("joinRoomBtn");

    const $addBtn  = document.getElementById("addBtn");
    const $newType = document.getElementById("newType");
    const $newTitle= document.getElementById("newTitle");
    const $newText = document.getElementById("newText");

    // ---------- State ----------
    let cards = []; // [{id,type, text, title?}]
    const genId = () => "c_" + Math.random().toString(36).slice(2, 9);

    // ---------- Render ----------
    window.renderCards = function renderCards(next) {
      cards = next.map(c => ({ id: c.id || genId(), ...c }));
      $board.innerHTML = "";
      for (const c of cards) {
        const el = document.createElement("div");
        el.className = "card";
        el.dataset.id = c.id;

        const header = document.createElement("div");
        header.className = "card-header";
        header.innerHTML = `
          <span class="drag-handle">⋮⋮</span>
          <span class="tag">${c.type === "section" ? "Section" : "Question"}</span>
          ${c.title ? `<strong style="margin-left:6px">${escapeHtml(c.title)}</strong>` : ""}
          <div class="spacer"></div>
          <button class="secondary" data-action="del">Delete</button>
        `;
        const body = document.createElement("div");
        body.className = "card-body";
        body.textContent = c.text;

        el.appendChild(header);
        el.appendChild(body);
        $board.appendChild(el);
      }
    };

    window.getCurrentCards = function getCurrentCards() {
      const order = [...$board.querySelectorAll(".card")].map(node => node.dataset.id);
      const byId = Object.fromEntries(cards.map(c => [c.id, c]));
      return order.map(id => byId[id]).filter(Boolean);
    };

    function persistOrderFromDOM() {
      cards = getCurrentCards();
    }

    // ---------- Drag & drop ----------
    Sortable.create($board, {
      animation: 150,
      handle: ".drag-handle",
      ghostClass: "ghost",
      direction: "vertical",
      onEnd: persistOrderFromDOM
    });

    // ---------- Events ----------
    $board.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action='del']");
      if (!btn) return;
      const node = btn.closest(".card");
      const id = node?.dataset.id;
      if (!id) return;
      cards = cards.filter(c => c.id !== id);
      node.remove();
    });

    $addBtn.addEventListener("click", () => {
      const type = $newType.value;
      const title = ($newTitle.value || "").trim();
      const text = ($newText.value || "").trim();
      if (!text) return;
      const item = { id: genId(), type, text };
      if (type === "section" && title) item.title = title;
      cards.push(item);
      renderCards(cards);
      $newText.value = ""; $newTitle.value = "";
    });

    $reset.addEventListener("click", () => {
      localStorage.removeItem("bhq-views-v2"); // shared view storage
      localStorage.removeItem("bhq-v1");       // legacy key if you had it
      location.reload();
    });

    $exportBtn.addEventListener("click", () => {
      const payload = {
        questions: getCurrentCards().filter(c => c.type === "question").map(c => c.text),
        sections: getCurrentCards().filter(c => c.type === "section").map(c => ({ title: c.title || "Section", body: c.text }))
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "guide-export.json"; a.click();
      URL.revokeObjectURL(url);
    });

    $importFile.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        const next = [
          ...(data.questions || []).map(q => ({ type: "question", text: q })),
          ...(data.sections || []).map(s => ({ type: "section", title: s.title, text: s.body }))
        ];
        renderCards(next);
        $status.textContent = `Imported: ${next.length} cards.`;
      } catch (err) {
        console.error(err);
        $status.textContent = "Import failed.";
      }
    });

    // Shared views
    function refreshViewList() {
      const names = listViews($room.value.trim());
      $sel.innerHTML = "";
      for (const n of names) {
        const opt = document.createElement("option");
        opt.value = n; opt.textContent = n;
        $sel.appendChild(opt);
      }
    }

    $join.addEventListener("click", async () => {
      await joinRoom($room.value.trim(), () => {
        refreshViewList();
      });
    });

    $save.addEventListener("click", () => {
      const name = $name.value.trim() || "Untitled";
      saveView({ name, cards: getCurrentCards(), roomCode: $room.value.trim() || null });
      refreshViewList();
      $status.textContent = `Saved view: "${name}".`;
    });

    $sel.addEventListener("change", () => {
      const name = $sel.value;
      const loaded = loadView({ name, roomCode: $room.value.trim() || null });
      if (loaded) renderCards(loaded);
    });

    refreshViewList();

    // ---------- Data loading (GitHub Pages static) ----------
    async function loadGuideJson(noCache = false) {
      $status.textContent = "Loading…";
      try {
        const url = noCache ? `/data/guide.json?ts=${Date.now()}` : "/data/guide.json";
        const res = await fetch(url, { cache: noCache ? "no-store" : "default" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const next = [
          ...(data.questions || []).map(q => ({ type: "question", text: q })),
          ...(data.sections || []).map(s => ({ type: "section", title: s.title, text: s.body }))
        ];
        renderCards(next);
        $status.textContent = `Loaded: ${next.length} cards (${(data.questions || []).length} questions, ${(data.sections || []).length} sections).`;
      } catch (err) {
        console.error(err);
        $status.textContent = "Failed to load data/guide.json";
      }
    }

    $loadLatest.addEventListener("click", () => loadGuideJson(false));
    $refresh.addEventListener("click", () => loadGuideJson(true));

    // Auto-load on first visit:
    loadGuideJson(false);

    // ---------- Utils ----------
    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }
  </script>
</body>
</html>
