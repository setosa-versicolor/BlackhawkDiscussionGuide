<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blackhawk Discussion Guide — Rooms</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#0e0f12; --panel:#161820; --card:#1e2230; --text:#e8ecf3;
      --muted:#9aa3b2; --accent:#7aa2ff; --border:#2a2f3c; --danger:#ff6b6b;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:940px;margin:28px auto 80px;padding:0 16px;}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
    header h1{font-size:20px;margin:0 12px 0 0;font-weight:700;}
    .bar{background:var(--panel);border:1px solid var(--border);border-radius:12px;
      padding:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    input[type="text"],select{background:#0f1117;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:8px 10px;outline:none;min-width:180px;}
    button{background:var(--accent);color:#0a0b0f;border:none;border-radius:10px;padding:9px 12px;
      font-weight:700;cursor:pointer;}
    button.secondary{background:#2b3040;color:var(--text);} button.danger{background:#ff6b6b;color:#101114;}
    .muted{color:#9aa3b2;} .spacer{flex:1}
    .board{display:block;margin-top:16px;}
    .card{width:100%;box-sizing:border-box;margin:12px 0;background:var(--card);
      border:1px solid var(--border);border-radius:16px;}
    .card-header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);}
    .drag-handle{cursor:grab;user-select:none;font-weight:900;letter-spacing:1px;opacity:.7;}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#2b3142;color:#cfe;}
    .card-body{padding:12px;white-space:pre-wrap;}
    .ghost{opacity:.5;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .row>*{flex:0 0 auto;} .row .grow{flex:1 1 240px;min-width:240px;}
    .hint{margin-top:8px;} .footer{margin-top:18px;color:#9aa3b2;font-size:13px;}
    /* Make the "Open PDF" anchor look like a secondary button (and not purple) */
      #pdfLink,
      #pdfLink:link,
      #pdfLink:visited {
        color: var(--text);
        background: #2b3040;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 9px 12px;
        display: inline-block;
        text-decoration: none;
      }
      #pdfLink:hover { opacity: .9; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Discussion Guide</h1>
      <span class="muted">Blackhawk Church</span>
    </header>

    <!-- Room controls -->
    <div class="bar">
      <select id="roomSelect" title="Rooms"></select>
      <input id="roomInput" type="text" placeholder="New room name…" />
      <button id="createJoinBtn">Create / Join</button>
      <button id="shareBtn" class="secondary">Copy Link</button>
      <div class="spacer"></div>
      <button id="loadLatestBtn" class="secondary" title="Load from data/guide.json">Load Latest Sermon</button>
      <button id="refreshBtn" class="secondary" title="Re-read data/guide.json with no cache">Refresh</button>
      <a id="pdfLink"
         class="secondary"
         href="#"
         target="_blank"
         rel="noopener"
         style="display:none; text-decoration:none; padding:9px 12px; border-radius:10px; border:1px solid var(--border);">
        Open PDF
      </a>
      
      <div class="spacer"></div>
      <button id="deleteRoomBtn" class="danger" title="Delete this room for everyone">Delete Room</button>
      <span class="muted" id="status"></span>
    </div>

    <!-- Add new card -->
    <div class="bar" style="margin-top:10px">
      <select id="newType">
        <option value="question">Question</option>
        <option value="section">Section</option>
      </select>
      <input id="newTitle" type="text" placeholder="(optional) Title for section" />
      <input id="newText" class="grow" type="text" placeholder="Type your question/section text…" />
      <button id="addBtn">Add</button>
    </div>

    <!-- Cards -->
    <div id="board" class="board"></div>

    <div class="hint muted">Rooms are live, and allow you to collaborate with others. Please note that anyone can see your room content.</div>
    <div class="hint muted">Drag and drop by clicking the dots in the upper left corner to put things in the order you want. </div>
    <div class="hint muted">If you ever make a mistake, or delete something you didn't intend to. Just use the Reset button. </div>
    <div class="footer">blackhawk.church/learn.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" crossorigin="anonymous"></script>

  <script type="module">
    import { connectFirebase, joinRoom, saveLive, loadLive, listRooms, currentRoomCode, deleteRoom } from "./static/js/viewStore.js";

    // ---- Firebase (paste your config) ----
    const FIREBASE_ENABLED = true;
    const firebaseConfig = {
      apiKey: "AIzaSyBMtVbKp6i5cnb_Zapc_sEW8rMebVjuIKs",
      authDomain: "blackhawk-discussion-guide.firebaseapp.com",
      projectId: "blackhawk-discussion-guide",
    };
    if (FIREBASE_ENABLED) { await connectFirebase(firebaseConfig); }

    // ---- DOM ----
    const $roomSel = document.getElementById("roomSelect");
    const $roomInp = document.getElementById("roomInput");
    const $createJoin = document.getElementById("createJoinBtn");
    const $share = document.getElementById("shareBtn");
    const $status = document.getElementById("status");
    const $pdfLink = document.getElementById("pdfLink");

    const $board = document.getElementById("board");
    const $addBtn = document.getElementById("addBtn");
    const $newType = document.getElementById("newType");
    const $newTitle= document.getElementById("newTitle");
    const $newText = document.getElementById("newText");

    const $deleteRoom = document.getElementById("deleteRoomBtn");
    const $loadLatest = document.getElementById("loadLatestBtn");
    const $refresh = document.getElementById("refreshBtn");

    // ---- State / render ----
    let cards = [];
    const genId = () => "c_" + Math.random().toString(36).slice(2,9);

    function renderCards(next) {
      cards = next.map(c => ({ id: c.id || genId(), ...c }));
      $board.innerHTML = "";
      for (const c of cards) {
        const el = document.createElement("div");
        el.className = "card";
        el.dataset.id = c.id;
        el.innerHTML = `
          <div class="card-header">
            <span class="drag-handle">⋮⋮</span>
            <span class="tag">${c.type === "section" ? "Section" : "Question"}</span>
            ${c.title ? `<strong style="margin-left:6px">${escapeHtml(c.title)}</strong>` : ""}
            <div class="spacer"></div>
            <button class="secondary" data-action="del">Delete</button>
          </div>
          <div class="card-body"></div>
        `;
        el.querySelector(".card-body").textContent = c.text;
        $board.appendChild(el);
      }
    }
    function getCurrentCards(){
      const order = [...$board.querySelectorAll(".card")].map(n=>n.dataset.id);
      const byId = Object.fromEntries(cards.map(c=>[c.id,c]));
      return order.map(id=>byId[id]).filter(Boolean);
    }
    function updateGuideLink(meta) {
      const u = (meta && meta.url) ? String(meta.url) : "";
      if (!u) { $pdfLink.style.display = "none"; return; }
    
      // If it looks like a PDF, label it “Open PDF”; otherwise “Open Source Page”
      const isPdf = u.toLowerCase().endsWith(".pdf");
      $pdfLink.textContent = isPdf ? "Open PDF" : "Open Source Page";
      $pdfLink.href = u;
      $pdfLink.style.display = "inline-block";
    }

    // Drag & drop + autosave
    Sortable.create($board, {
      animation:150, handle:".drag-handle", ghostClass:"ghost", direction:"vertical",
      onEnd(){ cards=getCurrentCards(); autoSave(); }
    });

    // Debounced autosave
    const debounce=(fn,ms=400)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const autoSave = debounce(()=>{
      if (!currentRoomCode()) return;
      saveLive(getCurrentCards());
    },400);

    // Add/Delete
    $addBtn.addEventListener("click", ()=>{
      const type=$newType.value;
      const title=($newTitle.value||"").trim();
      const text=($newText.value||"").trim();
      if(!text) return;
      const item={ id: genId(), type, text };
      if(type==="section" && title) item.title=title;
      renderCards([...cards, item]);
      $newText.value=""; $newTitle.value="";
      autoSave();
    });
    $board.addEventListener("click",(e)=>{
      const btn=e.target.closest("button[data-action='del']"); if(!btn) return;
      const id=btn.closest(".card")?.dataset.id; if(!id) return;
      renderCards(cards.filter(c=>c.id!==id));
      autoSave();
    });

    $deleteRoom.addEventListener("click", async () => {
      const code = currentRoomCode();
    
      if (!code) {
        // No room joined: offer to clear all local cached rooms instead
        const ok = confirm(
          "You are not in a room. This will clear ALL local cached rooms on this device. Continue?"
        );
        if (!ok) return;
        localStorage.removeItem("bhq-rooms-v1");
        location.reload();
        return;
      }
    
      const ok = confirm(
        `Delete room “${code}” for everyone?\n\n` +
        "This will remove the live board in Firestore and cannot be undone."
      );
      if (!ok) return;
    
      try {
        await deleteRoom(code);     // removes remote doc(s) if Firebase is enabled + local cache
        alert(`Room “${code}” deleted.`);
      } catch (e) {
        console.error(e);
        alert("Failed to delete room (see console).");
      }
    
      // Reset UI back to no room
      const url = new URL(location.href);
      url.searchParams.delete("room");
      location.href = url.toString();
    });

    
    // Rooms
    async function refreshRoomsList(selected){
      const rooms = await listRooms();
      $roomSel.innerHTML="";
      for(const r of rooms){
        const opt=document.createElement("option"); opt.value=r; opt.textContent=r;
        $roomSel.appendChild(opt);
      }
      if(selected && rooms.includes(selected)) $roomSel.value=selected;
    }

    async function joinAndLoad(room){
      await joinRoom(room, ()=>{
        // Snapshot callback – reload live view
        const state = loadLive();
        renderCards(state);
        $status.textContent = currentRoomCode()
          ? `Connected to room ${currentRoomCode()}`
          : `Local mode (not in a room)`;
      });
      await refreshRoomsList(currentRoomCode());
      // Initial load
      const state = loadLive();
      renderCards(state);
    }

    // ?room=CODE
    const urlRoom = new URLSearchParams(location.search).get("room");
    await joinAndLoad(urlRoom || null);
    await refreshRoomsList(currentRoomCode());

    $createJoin.addEventListener("click", async ()=>{
      const name = ($roomInp.value || "").trim();
      if(!name) return;
      await joinAndLoad(name);
      // add to URL
      const url = new URL(location.href); url.searchParams.set("room", name);
      history.replaceState(null, "", url.toString());
    });

    $roomSel.addEventListener("change", async ()=>{
      const name=$roomSel.value;
      await joinAndLoad(name);
      const url=new URL(location.href); url.searchParams.set("room", name);
      history.replaceState(null, "", url.toString());
    });

    $share.addEventListener("click", async ()=>{
      const code=currentRoomCode(); if(!code){ alert("Join a room first."); return; }
      const url=new URL(location.href); url.searchParams.set("room", code);
      await navigator.clipboard.writeText(url.toString());
      alert("Share link copied!");
    });

    // Guide.json loader
    const guideJsonUrl=(noCache=false)=>{ const u=new URL("data/guide.json",location.href); if(noCache) u.searchParams.set("ts",Date.now()); return u.toString(); };
    async function loadGuideJson(noCache=false){
      $status.textContent="Loading…";
      try{
        const res=await fetch(guideJsonUrl(noCache),{cache:noCache?"no-store":"default"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data=await res.json();
        const next=[
          ...(data.questions||[]).map(q=>({type:"question",text:q})),
          ...(data.sections||[]).map(s=>({type:"section",title:s.title,text:s.body}))
        ];
        updateGuideLink(data);
        renderCards(next);
        autoSave(); // seed the room with latest guide if desired
        $status.textContent=`Loaded: ${next.length} cards`;
      } catch { $status.textContent="Failed to load data/guide.json"; }
    }
    document.getElementById("loadLatestBtn").addEventListener("click", () => {
      const ok = confirm(
        "Load Latest Sermon will replace the current board with the latest guide.\n\n" +
        "Any unsaved changes in this room will be overwritten. Continue?"
      );
      if (!ok) return;
      loadGuideJson(false);   // your autoSave() call inside load path will persist to the room
    });
    
    document.getElementById("refreshBtn").addEventListener("click", () => {
      const ok = confirm(
        "Refresh will re-read the latest guide and overwrite the current board.\n\n" +
        "Any unsaved changes in this room will be overwritten. Continue?"
      );
      if (!ok) return;
      loadGuideJson(true);
    });

    // Reset
    document.getElementById("resetBtn").addEventListener("click", ()=>{
      localStorage.removeItem("bhq-rooms-v1");
      location.reload();
    });

    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  </script>
</body>
</html>
