<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Discussion Guide â€” Rooms</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <style>
    :root {
      --bg:#0e0f12; --panel:#161820; --card:#1e2230; --text:#e8ecf3;
      --muted:#9aa3b2; --accent:#7aa2ff; --border:#2a2f3c; --danger:#ff6b6b;
      --custom:#9b6bff; --edited:#ff9b6b;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:28px auto 80px;padding:0 16px;}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
    header h1{font-size:20px;margin:0 12px 0 0;font-weight:700;}
    .bar{background:var(--panel);border:1px solid var(--border);border-radius:12px;
      padding:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;position:relative;}
    .section-title{font-size:13px;font-weight:700;color:var(--muted);margin-bottom:8px;
      text-transform:uppercase;letter-spacing:0.5px;}
    input[type="text"],select{background:#0f1117;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:8px 10px;outline:none;min-width:180px;font-size:16px;}
    button{background:var(--accent);color:#0a0b0f;border:none;border-radius:10px;padding:9px 12px;
      font-weight:700;cursor:pointer;font-size:16px;}
    button.secondary{background:#2b3040;color:var(--text);}
    button.danger{background:var(--danger);color:#101114;}
    .muted{color:var(--muted);} .spacer{flex:1}
    .board{display:block;margin-top:8px;}
    .card{width:100%;box-sizing:border-box;margin:12px 0;background:var(--card);
      border:1px solid var(--border);border-radius:16px;position:relative;}
    .card-header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);}
    .drag-handle{cursor:grab;user-select:none;font-weight:900;letter-spacing:1px;opacity:.7;}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#2b3142;color:#cfe;}
    .tag.custom{background:var(--custom);color:#fff;}
    .tag.edited{background:var(--edited);color:#fff;}
    .card-body{padding:12px;white-space:pre-wrap;font-size:16px;}
    .ghost{opacity:.5;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .row>*{flex:0 0 auto;} .row .grow{flex:1 1 240px;min-width:240px;}
    .hint{margin-top:8px;} .footer{margin-top:18px;color:var(--muted);font-size:13px;}

    /* three lanes */
    .boards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 12px;
    }
    .board-wrap { background: transparent; }
    .board-title { 
      font-weight: 700; 
      color: var(--muted); 
      margin: 4px 0 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .board-title .count {
      font-size: 13px;
      color: var(--muted);
      opacity: 0.7;
    }
    .board-muted .card { opacity: .95; }
    .board-muted .drag-handle { opacity: .35; cursor: default; }

    /* compact icon buttons */
    .icon-btn {
      background: transparent; color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 4px 8px; line-height: 1; display: inline-flex; align-items: center;
    }
    .icon-btn:hover { opacity: .9; }
    .icon-btn.danger { border-color: #4d2630; }
    .icon-btn svg { width: 16px; height: 16px; display: block; }

    /* "Open PDF" anchor should look like button and not purple when visited */
    #pdfLink, #pdfLink:link, #pdfLink:visited {
      color: var(--text);
      background: #2b3040;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px 12px;
      display: inline-block;
      text-decoration: none;
    }
    #pdfLink:hover { opacity: .9; }

    /* Edit mode styles */
    .card.editing .card-body { display: none; }
    .card:not(.editing) .edit-area { display: none; }
    .edit-area {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .edit-area textarea {
      background: #0f1117;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      font-family: inherit;
      font-size: 16px;
      line-height: 1.5;
      min-height: 80px;
      resize: vertical;
      outline: none;
    }
    .edit-area .edit-controls {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .edit-area .edit-controls button {
      padding: 6px 12px;
      font-size: 16px;
    }

    /* Bible verses section */
    .card-verses {
      border-top: 1px solid var(--border);
      background: rgba(122, 162, 255, 0.03);
    }
    .verses-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }
    .verses-header:hover {
      background: rgba(122, 162, 255, 0.05);
    }
    .verses-icon {
      font-size: 16px;
    }
    .verses-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      flex: 1;
    }
    .verses-toggle {
      font-size: 12px;
      color: var(--muted);
    }
    .verses-content {
      padding: 0 12px 12px 12px;
      display: none;
    }
    .verses-content.visible {
      display: block;
    }
    .verse-block {
      margin-bottom: 16px;
    }
    .verse-block:last-child {
      margin-bottom: 0;
    }
    .verse-reference {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 6px;
    }
    .verse-text {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
      font-style: italic;
      padding-left: 12px;
      border-left: 3px solid var(--accent);
    }
    .verse-loading {
      font-size: 14px;
      color: var(--muted);
      font-style: italic;
    }
    .verse-error {
      font-size: 14px;
      color: var(--danger);
      font-style: italic;
    }

    /* Title input - hidden by default, shown for sections */
    #newTitle {
      display: none;
    }
    #newTitle.visible {
      display: block;
    }

    /* Search/filter bar */
    .filter-bar {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .filter-bar input {
      flex: 1;
      min-width: 200px;
    }
    .filter-bar .filter-count {
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }

    /* Hide filtered cards */
    .card.filtered {
      display: none;
    }

    /* Edited indicator */
    .edited-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--edited);
      color: #fff;
      margin-left: 4px;
    }

    /* Hamburger menu */
    .menu-toggle {
      position: relative;
    }
    .menu-toggle button {
      background: #2b3040;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 8px 12px;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }
    .menu-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 4px;
      display: none;
      flex-direction: column;
      gap: 2px;
      min-width: 180px;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .menu-dropdown.visible {
      display: flex;
    }
    .menu-dropdown button {
      background: transparent;
      color: var(--text);
      border: none;
      padding: 10px 12px;
      text-align: left;
      border-radius: 8px;
      font-weight: 500;
      font-size: 15px;
    }
    .menu-dropdown button:hover {
      background: #2b3040;
    }
    .menu-dropdown button.danger {
      color: var(--danger);
    }

    /* Sermon date display */
    .sermon-date {
      font-size: 13px;
      color: var(--muted);
      font-style: italic;
      white-space: nowrap;
    }

    /* Keyboard shortcuts help */
    .shortcuts-help {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: none;
      max-width: 300px;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .shortcuts-help.visible {
      display: block;
    }
    .shortcuts-help h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: var(--text);
    }
    .shortcuts-help .shortcut {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      font-size: 13px;
    }
    .shortcuts-help .key {
      background: #2b3040;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .shortcuts-help .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      font-size: 18px;
      line-height: 1;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      html, body {
        font-size: 16px;
      }
      .wrap {
        padding: 0 12px;
        margin: 20px auto 60px;
      }
      .bar {
        padding: 8px;
        gap: 6px;
      }
      button {
        padding: 8px 10px;
        font-size: 15px;
      }
      input[type="text"], select {
        min-width: 140px;
        font-size: 16px;
        padding: 10px;
      }
      .card-body {
        padding: 14px;
        font-size: 16px;
        line-height: 1.6;
      }
      .edit-area textarea {
        font-size: 16px;
        padding: 12px;
      }
      .shortcuts-help {
        right: 10px;
        bottom: 10px;
        max-width: calc(100vw - 40px);
      }
      .menu-dropdown {
        right: 0;
        min-width: 160px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Discussion Guide</h1>
      <span class="muted">Blackhawk Church</span>
    </header>

    <!-- Room Details -->
    <div class="section-title">Room Details</div>
    <div class="bar">
      <select id="roomSelect" title="Rooms"></select>
      <input id="roomInput" type="text" placeholder="New room nameâ€¦" />
      <button id="createJoinBtn">Create / Join</button>

      <a id="pdfLink" href="#" target="_blank" rel="noopener" style="display:none">Open PDF</a>

      <div class="spacer"></div>
      
      <span class="sermon-date" id="sermonDate"></span>
      <button id="loadLatestBtn" class="secondary" title="Load from data/guide.json">Load Latest Sermon</button>
      
      <!-- Hamburger Menu -->
      <div class="menu-toggle">
        <button id="menuToggle" title="More options">â˜°</button>
        <div class="menu-dropdown" id="menuDropdown">
          <button id="shareBtn" class="secondary">Copy Share Link</button>
          <button id="refreshBtn" class="secondary">Refresh</button>
          <button id="helpBtn" class="secondary">Keyboard Shortcuts (?)</button>
          <button id="deleteRoomBtn" class="danger">Delete Room</button>
        </div>
      </div>
      
      <span class="muted" id="status"></span>
    </div>

    <!-- Search -->
    <div class="section-title" style="margin-top:16px">Search</div>
    <div class="bar filter-bar">
      <input id="searchInput" type="text" placeholder="Search questions..." />
      <button id="clearSearchBtn" class="secondary">Clear</button>
      <span class="filter-count" id="filterCount"></span>
    </div>

    <!-- Add Custom Questions -->
    <div class="section-title" style="margin-top:16px">Add Custom Questions</div>
    <div class="bar">
      <select id="newType">
        <option value="question">Question</option>
        <option value="section">Section</option>
      </select>
      <input id="newTitle" type="text" placeholder="Section title" />
      <input id="newText" class="grow" type="text" placeholder="Type your question/section textâ€¦" />
      <button id="addBtn">Add</button>
    </div>

    <!-- Boards -->
    <div class="boards">
      <div class="board-wrap">
        <div class="board-title">
          Active
          <span class="count" id="activeCount"></span>
        </div>
        <div id="boardActive" class="board"></div>
      </div>
      <div class="board-wrap">
        <div class="board-title">
          Completed
          <span class="count" id="doneCount"></span>
        </div>
        <div id="boardDone" class="board board-muted"></div>
      </div>
      <div class="board-wrap">
        <div class="board-title">
          Deleted
          <span class="count" id="deletedCount"></span>
        </div>
        <div id="boardDeleted" class="board board-muted"></div>
      </div>
    </div>

    <div class="hint muted">If you don't see anything on the page, start by clicking "Load Latest Sermon"</div>
    <div class="hint muted">Rooms allow you to share your view with others and collaborate in real time. Press <strong>?</strong> for keyboard shortcuts.</div>
    <div class="footer">blackhawk.church/learn</div>
  </div>

  <!-- Keyboard shortcuts help panel -->
  <div class="shortcuts-help" id="shortcutsHelp">
    <button class="close-btn" id="closeHelp">&times;</button>
    <h3>Keyboard Shortcuts</h3>
    <div class="shortcut">
      <span>Show/hide help</span>
      <span class="key">?</span>
    </div>
    <div class="shortcut">
      <span>Search</span>
      <span class="key">/</span>
    </div>
    <div class="shortcut">
      <span>Clear search</span>
      <span class="key">Esc</span>
    </div>
    <div class="shortcut">
      <span>Add new card</span>
      <span class="key">n</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" crossorigin="anonymous"></script>

  <script type="module">
    import { connectFirebase, joinRoom, saveLive, loadLive, listRooms, currentRoomCode, deleteRoom } from "./static/js/viewStore.js";

    // ---- Firebase (paste your config) ----
    const FIREBASE_ENABLED = true;
    const firebaseConfig = {
      apiKey: "AIzaSyBMtVbKp6i5cnb_Zapc_sEW8rMebVjuIKs",
      authDomain: "blackhawk-discussion-guide.firebaseapp.com",
      projectId: "blackhawk-discussion-guide",
    };
    if (FIREBASE_ENABLED) { await connectFirebase(firebaseConfig); }

    // ---- Bible Verse Detection & Fetching ----
    const verseCache = {}; // Cache fetched verses

    // Book name mappings (handles abbreviations)
    const bookMappings = {
      // Old Testament
      'gen': 'Genesis', 'genesis': 'Genesis',
      'ex': 'Exodus', 'exo': 'Exodus', 'exod': 'Exodus', 'exodus': 'Exodus',
      'lev': 'Leviticus', 'leviticus': 'Leviticus',
      'num': 'Numbers', 'numbers': 'Numbers',
      'deut': 'Deuteronomy', 'dt': 'Deuteronomy', 'deuteronomy': 'Deuteronomy',
      'josh': 'Joshua', 'joshua': 'Joshua',
      'judg': 'Judges', 'judges': 'Judges',
      'ruth': 'Ruth',
      '1 sam': '1 Samuel', '1 samuel': '1 Samuel', '1sam': '1 Samuel',
      '2 sam': '2 Samuel', '2 samuel': '2 Samuel', '2sam': '2 Samuel',
      '1 kings': '1 Kings', '1 ki': '1 Kings', '1ki': '1 Kings',
      '2 kings': '2 Kings', '2 ki': '2 Kings', '2ki': '2 Kings',
      '1 chron': '1 Chronicles', '1 chronicles': '1 Chronicles', '1chron': '1 Chronicles',
      '2 chron': '2 Chronicles', '2 chronicles': '2 Chronicles', '2chron': '2 Chronicles',
      'ezra': 'Ezra',
      'neh': 'Nehemiah', 'nehemiah': 'Nehemiah',
      'esth': 'Esther', 'esther': 'Esther',
      'job': 'Job',
      'ps': 'Psalm', 'psa': 'Psalm', 'psalm': 'Psalm', 'psalms': 'Psalm',
      'prov': 'Proverbs', 'proverbs': 'Proverbs',
      'eccl': 'Ecclesiastes', 'ecclesiastes': 'Ecclesiastes',
      'song': 'Song of Solomon', 'song of solomon': 'Song of Solomon',
      'isa': 'Isaiah', 'isaiah': 'Isaiah',
      'jer': 'Jeremiah', 'jeremiah': 'Jeremiah',
      'lam': 'Lamentations', 'lamentations': 'Lamentations',
      'ezek': 'Ezekiel', 'ezekiel': 'Ezekiel',
      'dan': 'Daniel', 'daniel': 'Daniel',
      'hos': 'Hosea', 'hosea': 'Hosea',
      'joel': 'Joel',
      'amos': 'Amos',
      'obad': 'Obadiah', 'obadiah': 'Obadiah',
      'jonah': 'Jonah',
      'mic': 'Micah', 'micah': 'Micah',
      'nah': 'Nahum', 'nahum': 'Nahum',
      'hab': 'Habakkuk', 'habakkuk': 'Habakkuk',
      'zeph': 'Zephaniah', 'zephaniah': 'Zephaniah',
      'hag': 'Haggai', 'haggai': 'Haggai',
      'zech': 'Zechariah', 'zechariah': 'Zechariah',
      'mal': 'Malachi', 'malachi': 'Malachi',
      // New Testament
      'matt': 'Matthew', 'mt': 'Matthew', 'matthew': 'Matthew',
      'mark': 'Mark', 'mk': 'Mark',
      'luke': 'Luke', 'lk': 'Luke',
      'john': 'John', 'jn': 'John',
      'acts': 'Acts',
      'rom': 'Romans', 'romans': 'Romans',
      '1 cor': '1 Corinthians', '1 corinthians': '1 Corinthians', '1cor': '1 Corinthians',
      '2 cor': '2 Corinthians', '2 corinthians': '2 Corinthians', '2cor': '2 Corinthians',
      'gal': 'Galatians', 'galatians': 'Galatians',
      'eph': 'Ephesians', 'ephesians': 'Ephesians',
      'phil': 'Philippians', 'php': 'Philippians', 'philippians': 'Philippians',
      'col': 'Colossians', 'colossians': 'Colossians',
      '1 thess': '1 Thessalonians', '1 thessalonians': '1 Thessalonians', '1thess': '1 Thessalonians',
      '2 thess': '2 Thessalonians', '2 thessalonians': '2 Thessalonians', '2thess': '2 Thessalonians',
      '1 tim': '1 Timothy', '1 timothy': '1 Timothy', '1tim': '1 Timothy',
      '2 tim': '2 Timothy', '2 timothy': '2 Timothy', '2tim': '2 Timothy',
      'titus': 'Titus',
      'philem': 'Philemon', 'philemon': 'Philemon',
      'heb': 'Hebrews', 'hebrews': 'Hebrews',
      'james': 'James', 'jas': 'James',
      '1 pet': '1 Peter', '1 peter': '1 Peter', '1pet': '1 Peter',
      '2 pet': '2 Peter', '2 peter': '2 Peter', '2pet': '2 Peter',
      '1 john': '1 John', '1john': '1 John', '1 jn': '1 John',
      '2 john': '2 John', '2john': '2 John', '2 jn': '2 John',
      '3 john': '3 John', '3john': '3 John', '3 jn': '3 John',
      'jude': 'Jude',
      'rev': 'Revelation', 'revelation': 'Revelation'
    };

    function detectVerseReferences(text) {
      // Enhanced regex to catch more patterns
      const patterns = [
        // Standard: "Colossians 2:13-15" or "Col 2:13-15"
        /\b((?:1|2|3)\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)\s+(\d+):(\d+)(?:-(\d+))?\b/gi,
        // With period: "Col. 2:13-15"
        /\b((?:1|2|3)\s+)?([A-Z][a-z]+)\.\s+(\d+):(\d+)(?:-(\d+))?\b/gi
      ];

      const references = [];
      const seen = new Set();

      for (const pattern of patterns) {
        let match;
        while ((match = pattern.exec(text)) !== null) {
          const prefix = match[1] ? match[1].trim() + ' ' : '';
          const book = match[2];
          const chapter = match[3];
          const verseStart = match[4];
          const verseEnd = match[5] || verseStart;

          // Normalize book name
          const bookKey = (prefix + book).toLowerCase().replace(/\.$/, '');
          const normalizedBook = bookMappings[bookKey];
          
          // Skip if book name not recognized
          if (!normalizedBook) continue;

          const reference = `${normalizedBook} ${chapter}:${verseStart}${verseEnd !== verseStart ? '-' + verseEnd : ''}`;
          const key = reference.toLowerCase();

          if (!seen.has(key)) {
            seen.add(key);
            references.push({
              reference,
              apiReference: `${normalizedBook}+${chapter}:${verseStart}-${verseEnd}`
            });
          }
        }
      }

      return references;
    }

    async function fetchVerse(apiReference) {
      // Check cache first
      if (verseCache[apiReference]) {
        return verseCache[apiReference];
      }

      try {
        const response = await fetch(`https://bible-api.com/${apiReference}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        
        const result = {
          text: data.text.trim(),
          reference: data.reference,
          translation: data.translation_name || 'World English Bible'
        };

        // Cache the result
        verseCache[apiReference] = result;
        return result;
      } catch (error) {
        console.error('Error fetching verse:', error);
        return {
          error: true,
          message: 'Unable to load verse'
        };
      }
    }

    // ---- DOM ----
    const $roomSel = document.getElementById("roomSelect");
    const $roomInp = document.getElementById("roomInput");
    const $createJoin = document.getElementById("createJoinBtn");
    const $share = document.getElementById("shareBtn");
    const $status = document.getElementById("status");
    const $pdfLink = document.getElementById("pdfLink");
    const $sermonDate = document.getElementById("sermonDate");

    const $boardActive  = document.getElementById("boardActive");
    const $boardDone    = document.getElementById("boardDone");
    const $boardDeleted = document.getElementById("boardDeleted");
    const $boards       = document.querySelector(".boards");

    const $addBtn = document.getElementById("addBtn");
    const $newType = document.getElementById("newType");
    const $newTitle= document.getElementById("newTitle");
    const $newText = document.getElementById("newText");

    const $deleteRoom = document.getElementById("deleteRoomBtn");
    const $loadLatest = document.getElementById("loadLatestBtn");
    const $refresh = document.getElementById("refreshBtn");

    const $searchInput = document.getElementById("searchInput");
    const $clearSearch = document.getElementById("clearSearchBtn");
    const $filterCount = document.getElementById("filterCount");

    const $helpBtn = document.getElementById("helpBtn");
    const $shortcutsHelp = document.getElementById("shortcutsHelp");
    const $closeHelp = document.getElementById("closeHelp");

    const $menuToggle = document.getElementById("menuToggle");
    const $menuDropdown = document.getElementById("menuDropdown");

    const $activeCount = document.getElementById("activeCount");
    const $doneCount = document.getElementById("doneCount");
    const $deletedCount = document.getElementById("deletedCount");

    // ---- Hamburger menu ----
    $menuToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      $menuDropdown.classList.toggle("visible");
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".menu-toggle")) {
        $menuDropdown.classList.remove("visible");
      }
    });

    $menuDropdown.addEventListener("click", () => {
      $menuDropdown.classList.remove("visible");
    });

    // ---- Icons (flat SVG) ----
    const ICONS = {
      check: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 6L9 17l-5-5" />
        </svg>`,
      trash: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18" />
          <path d="M8 6V4h8v2" />
          <path d="M19 6l-1 14H6L5 6" />
          <path d="M10 11v6M14 11v6" />
        </svg>`,
      undo: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 9l-4 4 4 4" />
          <path d="M3 13h9a6 6 0 016 6" />
        </svg>`,
      edit: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
        </svg>`
    };

    // ---- State / render ----
    let cards = [];
    let currentSermonDate = null;
    const genId = () => "c_" + Math.random().toString(36).slice(2,9);
    let searchQuery = "";

    $newType.addEventListener("change", () => {
      if ($newType.value === "section") {
        $newTitle.classList.add("visible");
      } else {
        $newTitle.classList.remove("visible");
        $newTitle.value = "";
      }
    });

    function updateSermonDate(dateStr) {
      if (dateStr) {
        currentSermonDate = dateStr;
        $sermonDate.textContent = dateStr;
        $sermonDate.style.display = "inline";
      } else {
        currentSermonDate = null;
        $sermonDate.textContent = "";
        $sermonDate.style.display = "none";
      }
    }

    function updateCardCounts() {
      const active = cards.filter(c => c.status === 'active').length;
      const done = cards.filter(c => c.status === 'done').length;
      const deleted = cards.filter(c => c.status === 'deleted').length;
      
      $activeCount.textContent = `(${active})`;
      $doneCount.textContent = `(${done})`;
      $deletedCount.textContent = `(${deleted})`;
    }

    function updateFilterCount() {
      if (!searchQuery) {
        $filterCount.textContent = "";
        return;
      }
      const visible = cards.filter(c => {
        const text = (c.text || "").toLowerCase();
        const title = (c.title || "").toLowerCase();
        const query = searchQuery.toLowerCase();
        return text.includes(query) || title.includes(query);
      }).length;
      $filterCount.textContent = `Showing ${visible} of ${cards.length}`;
    }

    function applySearch() {
      const query = searchQuery.toLowerCase();
      document.querySelectorAll(".card").forEach(cardEl => {
        if (!query) {
          cardEl.classList.remove("filtered");
          return;
        }
        const id = cardEl.dataset.id;
        const card = cards.find(c => c.id === id);
        if (!card) {
          cardEl.classList.add("filtered");
          return;
        }
        const text = (card.text || "").toLowerCase();
        const title = (card.title || "").toLowerCase();
        const matches = text.includes(query) || title.includes(query);
        if (matches) {
          cardEl.classList.remove("filtered");
        } else {
          cardEl.classList.add("filtered");
        }
      });
      updateFilterCount();
    }

    async function createVersesSection(text) {
      const references = detectVerseReferences(text);
      
      if (references.length === 0) {
        return null;
      }

      const versesDiv = document.createElement("div");
      versesDiv.className = "card-verses";

      const header = document.createElement("div");
      header.className = "verses-header";
      header.innerHTML = `
        <span class="verses-icon">ðŸ“–</span>
        <span class="verses-title">Bible Verses (${references.length})</span>
        <span class="verses-toggle">Click to expand</span>
      `;

      const content = document.createElement("div");
      content.className = "verses-content";

      // Toggle functionality
      header.addEventListener("click", () => {
        content.classList.toggle("visible");
        const toggle = header.querySelector(".verses-toggle");
        toggle.textContent = content.classList.contains("visible") 
          ? "Click to collapse" 
          : "Click to expand";
      });

      versesDiv.appendChild(header);
      versesDiv.appendChild(content);

      // Fetch all verses
      for (const ref of references) {
        const block = document.createElement("div");
        block.className = "verse-block";

        const refTitle = document.createElement("div");
        refTitle.className = "verse-reference";
        refTitle.textContent = ref.reference;

        const verseText = document.createElement("div");
        verseText.className = "verse-text verse-loading";
        verseText.textContent = "Loading...";

        block.appendChild(refTitle);
        block.appendChild(verseText);
        content.appendChild(block);

        // Fetch the verse
        fetchVerse(ref.apiReference).then(result => {
          if (result.error) {
            verseText.className = "verse-text verse-error";
            verseText.textContent = result.message;
          } else {
            verseText.className = "verse-text";
            verseText.textContent = result.text;
          }
        });
      }

      return versesDiv;
    }

    async function renderCards(next) {
      cards = next.map(c => ({ 
        status: 'active', 
        source: 'pdf',
        ...c, 
        id: c.id || genId() 
      }));

      $boardActive.innerHTML  = "";
      $boardDone.innerHTML    = "";
      $boardDeleted.innerHTML = "";

      for (const c of cards) {
        const el = document.createElement("div");
        el.className = "card"; 
        el.dataset.id = c.id;

        const isEdited = c.originalText && c.originalText !== c.text;

        const header = document.createElement("div");
        header.className = "card-header";
        
        let tagClass = "";
        let tagText = c.type === "section" ? "Section" : "Question";
        if (c.source === "custom") {
          tagClass = "custom";
          tagText = c.type === "section" ? "Section" : "Custom Question";
        } else if (isEdited) {
          tagClass = "edited";
        }

        header.innerHTML = `
          <span class="drag-handle">â‹®â‹®</span>
          <span class="tag ${tagClass}">${tagText}</span>
          ${c.title ? `<strong style="margin-left:6px">${escapeHtml(c.title)}</strong>` : ""}
          ${isEdited ? '<span class="edited-badge">EDITED</span>' : ''}
          <div class="spacer"></div>
          ${c.status === 'active' ? `
            <button class="icon-btn" data-action="edit" title="Edit" aria-label="Edit">
              ${ICONS.edit}
            </button>
            <button class="icon-btn" data-action="complete" title="Mark complete" aria-label="Mark complete">
              ${ICONS.check}
            </button>
            <button class="icon-btn danger" data-action="trash" title="Move to deleted" aria-label="Move to deleted">
              ${ICONS.trash}
            </button>
          ` : `
            <button class="icon-btn" data-action="undo" title="Move back to active" aria-label="Undo">
              ${ICONS.undo}
            </button>
          `}
        `;
        
        const body = document.createElement("div");
        body.className = "card-body";
        body.textContent = c.text;

        const editArea = document.createElement("div");
        editArea.className = "edit-area";
        editArea.innerHTML = `
          <textarea class="edit-textarea">${escapeHtml(c.text)}</textarea>
          <div class="edit-controls">
            <button class="secondary" data-action="cancel-edit">Cancel</button>
            <button data-action="save-edit">Save</button>
          </div>
        `;

        el.appendChild(header);
        el.appendChild(body);
        el.appendChild(editArea);

        // Add Bible verses section if verses detected
        if (c.type === "question") {
          const versesSection = await createVersesSection(c.text);
          if (versesSection) {
            el.appendChild(versesSection);
          }
        }

        if (c.status === "done") $boardDone.appendChild(el);
        else if (c.status === "deleted") $boardDeleted.appendChild(el);
        else $boardActive.appendChild(el);
      }

      updateCardCounts();
      applySearch();
    }

    function getCurrentCards() {
      const byId = Object.fromEntries(cards.map(c => [c.id, c]));
      const read = (container, status) =>
        [...container.querySelectorAll(".card")].map(n => {
          const id = n.dataset.id;
          return { ...byId[id], status };
        });
      return [
        ...read($boardActive,  'active'),
        ...read($boardDone,    'done'),
        ...read($boardDeleted, 'deleted'),
      ];
    }

    Sortable.create($boardActive, {
      animation:150, handle:".drag-handle", ghostClass:"ghost", direction:"vertical",
      onEnd(){ cards=getCurrentCards(); autoSave(); }
    });

    const debounce=(fn,ms=400)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const autoSave = debounce(()=>{
      if (!currentRoomCode()) return;
      saveLive(getCurrentCards());
    },400);

    document.querySelector(".boards").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
    
      const card = btn.closest(".card");
      if (!card) return;
      
      const id = card.dataset.id;
      const action = btn.dataset.action;

      if (action === "edit") {
        card.classList.add("editing");
        const textarea = card.querySelector(".edit-textarea");
        if (textarea) {
          textarea.focus();
          textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
        return;
      }

      if (action === "cancel-edit") {
        card.classList.remove("editing");
        const originalCard = cards.find(c => c.id === id);
        if (originalCard) {
          const textarea = card.querySelector(".edit-textarea");
          if (textarea) textarea.value = originalCard.text;
        }
        return;
      }

      if (action === "save-edit") {
        const textarea = card.querySelector(".edit-textarea");
        if (!textarea) return;
        
        const newText = textarea.value.trim();
        if (!newText) {
          alert("Card text cannot be empty");
          return;
        }

        const current = getCurrentCards();
        const next = current.map(c => {
          if (c.id !== id) return c;
          const originalText = c.originalText || (c.source === 'pdf' ? c.text : undefined);
          return { ...c, text: newText, originalText };
        });
        
        renderCards(next);
        autoSave();
        return;
      }

      let newStatus;
      if (action === "complete") newStatus = "done";
      else if (action === "trash") newStatus = "deleted";
      else if (action === "undo") newStatus = "active";
      else return;
    
      const current = getCurrentCards();
      const next = current.map(c => (c.id === id ? { ...c, status: newStatus } : c));
    
      renderCards(next);
      autoSave();
    });

    document.getElementById("addBtn").addEventListener("click", ()=>{
      const type=$newType.value;
      const title=($newTitle.value||"").trim();
      const text=($newText.value||"").trim();
      if(!text) return;
      const item={ 
        id: genId(), 
        type, 
        text, 
        status:"active",
        source: "custom"
      };
      if(type==="section" && title) item.title=title;
      
      renderCards([item, ...cards]);
      $newText.value=""; $newTitle.value="";
      autoSave();
    });

    $searchInput.addEventListener("input", (e) => {
      searchQuery = e.target.value;
      applySearch();
    });

    $clearSearch.addEventListener("click", () => {
      searchQuery = "";
      $searchInput.value = "";
      applySearch();
    });

    document.addEventListener("keydown", (e) => {
      if (e.target.matches("input, textarea")) {
        if (e.key === "Escape" && e.target === $searchInput) {
          $clearSearch.click();
          $searchInput.blur();
        }
        return;
      }

      if (e.key === "?") {
        e.preventDefault();
        $shortcutsHelp.classList.toggle("visible");
        return;
      }

      if (e.key === "/") {
        e.preventDefault();
        $searchInput.focus();
        return;
      }

      if (e.key === "Escape") {
        e.preventDefault();
        $clearSearch.click();
        return;
      }

      if (e.key === "n" || e.key === "N") {
        e.preventDefault();
        $newText.focus();
        return;
      }
    });

    $helpBtn.addEventListener("click", () => {
      $shortcutsHelp.classList.toggle("visible");
    });

    $closeHelp.addEventListener("click", () => {
      $shortcutsHelp.classList.remove("visible");
    });

    async function refreshRoomsList(selected){
      const rooms = await listRooms();
      $roomSel.innerHTML="";
      for(const r of rooms){
        const opt=document.createElement("option"); opt.value=r; opt.textContent=r;
        $roomSel.appendChild(opt);
      }
      if(selected && rooms.includes(selected)) $roomSel.value=selected;
    }

    async function joinAndLoad(room){
      await joinRoom(room, ()=>{
        const state = loadLive();
        renderCards(state);
        $status.textContent = currentRoomCode()
          ? `Connected to room ${currentRoomCode()}`
          : `Local mode (not in a room)`;
      });
      await refreshRoomsList(currentRoomCode());
      const state = loadLive();
      renderCards(state);
    }

    const urlRoom = new URLSearchParams(location.search).get("room");
    await joinAndLoad(urlRoom || null);
    await refreshRoomsList(currentRoomCode());

    $createJoin.addEventListener("click", async ()=>{
      const name = ($roomInp.value || "").trim();
      if(!name) return;
      await joinAndLoad(name);
      const url = new URL(location.href); url.searchParams.set("room", name);
      history.replaceState(null, "", url.toString());
    });

    $roomSel.addEventListener("change", async ()=>{
      const name=$roomSel.value;
      await joinAndLoad(name);
      const url=new URL(location.href); url.searchParams.set("room", name);
      history.replaceState(null, "", url.toString());
    });

    $share.addEventListener("click", async ()=>{
      const code=currentRoomCode(); if(!code){ alert("Join a room first."); return; }
      const url=new URL(location.href); url.searchParams.set("room", code);
      await navigator.clipboard.writeText(url.toString());
      alert("Share link copied!");
    });

    $deleteRoom.addEventListener("click", async () => {
      const code = currentRoomCode();

      if (!code) {
        const ok = confirm(
          "You are not in a room. This will clear ALL local cached rooms on this device. Continue?"
        );
        if (!ok) return;
        localStorage.removeItem("bhq-rooms-v1");
        location.reload();
        return;
      }

      const ok = confirm(
        `Delete room "${code}" for everyone?\n\nThis will remove the room for everyone, not just you. Continue?`
      );
      if (!ok) return;

      try {
        await deleteRoom(code);
        alert(`Room "${code}" deleted.`);
      } catch (e) {
        console.error(e);
        alert("Failed to delete room (see console).");
      }

      const url = new URL(location.href);
      url.searchParams.delete("room");
      location.href = url.toString();
    });

    const guideJsonUrl=(noCache=false)=>{ const u=new URL("data/guide.json",location.href); if(noCache) u.searchParams.set("ts",Date.now()); return u.toString(); };
    
    function extractDateFromUrl(url) {
      const match = url.match(/(\d{1,2})\.(\d{1,2})\.(\d{2})/);
      if (match) {
        const month = parseInt(match[1]);
        const day = parseInt(match[2]);
        const year = 2000 + parseInt(match[3]);
        const date = new Date(year, month - 1, day);
        return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      }
      return null;
    }
    
    function updateGuideLink(meta){
      const u = (meta && meta.url) ? String(meta.url) : "";
      if (!u) { 
        $pdfLink.style.display = "none";
        updateSermonDate(null);
        return;
      }
      
      const isPdf = u.toLowerCase().endsWith(".pdf");
      $pdfLink.textContent = isPdf ? "Open PDF" : "Open Source Page";
      $pdfLink.href = u;
      $pdfLink.style.display = "inline-block";
      
      const dateStr = extractDateFromUrl(u);
      updateSermonDate(dateStr);
    }
    
    async function loadGuideJson(noCache=false){
      $status.textContent="Loadingâ€¦";
      try{
        const res=await fetch(guideJsonUrl(noCache),{cache:noCache?"no-store":"default"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data=await res.json();
        updateGuideLink(data);
        const next=[
          ...(data.questions||[]).map(q=>({
            type:"question",
            text:q,
            status:"active",
            source:"pdf"
          })),
          ...(data.sections||[]).map(s=>({
            type:"section",
            title:s.title,
            text:s.body,
            status:"active",
            source:"pdf"
          }))
        ];
        renderCards(next);
        autoSave();
        $status.textContent=`Loaded: ${next.length} cards`;
      } catch (e) {
        console.error(e);
        $status.textContent="Failed to load data/guide.json";
      }
    }

    $loadLatest.addEventListener("click", () => {
      const ok = confirm(
        "Load Latest Sermon will replace the current board with the latest Discussion Guide.\n\nAny changes in this room will be overwritten. Continue?"
      );
      if (!ok) return;
      loadGuideJson(false);
    });
    
    $refresh.addEventListener("click", () => {
      const ok = confirm(
        "Refresh will re-read the latest guide and overwrite the current Discussion Guide questions.\n\nAny changes will be overwritten. Continue?"
      );
      if (!ok) return;
      loadGuideJson(true);
    });

    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  </script>
</body>
</html>
