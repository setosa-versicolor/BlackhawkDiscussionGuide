<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Discussion Guide — Cards</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0e0f12; --panel:#161820; --card:#1e2230; --text:#e8ecf3; --muted:#9aa3b2; --accent:#7aa2ff; --border:#2a2f3c; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:920px;margin:28px auto 80px;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    header h1{font-size:20px;margin:0 12px 0 0;font-weight:700}
    .bar,.viewbar{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"],select,textarea{background:#0f1117;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;outline:none;min-width:180px}
    button{background:var(--accent);color:#0a0b0f;border:none;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
    button.secondary{background:#2b3040;color:var(--text)}
    .muted{color:var(--muted)} .spacer{flex:1}
    .board{display:block;margin-top:16px}
    .card{width:100%;box-sizing:border-box;margin:12px 0;background:var(--card);border:1px solid var(--border);border-radius:16px}
    .card-header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
    .drag-handle{cursor:grab;user-select:none;font-weight:900;letter-spacing:1px;opacity:.7}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#2b3142;color:#cfe}
    .card-body{padding:12px;white-space:pre-wrap}
    .ghost{opacity:.5}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row>*{flex:0 0 auto} .row .grow{flex:1 1 240px;min-width:240px}
    .hint{margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Discussion Guide</h1>
      <span class="muted">interactive questions + shared views</span>
    </header>

    <div class="bar">
      <input id="urlInput" class="grow" type="text" placeholder="Paste the guide URL…" />
      <button id="loadBtn">Load</button>
      <button id="resetBtn" class="secondary">Reset</button>
      <div class="spacer"></div>
      <span id="status" class="muted"></span>
    </div>

    <div class="viewbar" style="margin-top:10px">
      <select id="viewSelect"></select>
      <input id="viewName" type="text" placeholder="New view name…" />
      <button id="saveViewBtn">Save / Update</button>
      <div class="spacer"></div>
      <input id="roomCode" type="text" placeholder="Room code (optional)" />
      <button id="joinRoomBtn">Join</button>
    </div>

    <div class="bar" style="margin-top:10px">
      <select id="newType">
        <option value="question">Question</option>
        <option value="section">Section</option>
      </select>
      <input id="newTitle" type="text" placeholder="(optional) Section title" />
      <input id="newText" class="grow" type="text" placeholder="Type your question/section text…" />
      <button id="addBtn">Add</button>
    </div>

    <div id="board" class="board"></div>
    <div class="hint muted">Tip: drag with “⋮⋮”. Use the dropdown to switch/sync views.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" crossorigin="anonymous"></script>
  <script type="module">
    import { listViews, loadView, saveView, joinRoom } from "./static/js/viewStore.js";

    const $board=document.getElementById("board");
    const $url=document.getElementById("urlInput");
    const $load=document.getElementById("loadBtn");
    const $reset=document.getElementById("resetBtn");
    const $status=document.getElementById("status");

    const $sel=document.getElementById("viewSelect");
    const $name=document.getElementById("viewName");
    const $room=document.getElementById("roomCode");
    const $save=document.getElementById("saveViewBtn");
    const $join=document.getElementById("joinRoomBtn");

    const $addBtn=document.getElementById("addBtn");
    const $newType=document.getElementById("newType");
    const $newTitle=document.getElementById("newTitle");
    const $newText=document.getElementById("newText");

    let cards=[]; const genId=()=> "c_"+Math.random().toString(36).slice(2,9);
    const escapeHtml = s => s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));

    function renderCards(next){
      cards=next.map(c=>({id:c.id||genId(),...c}));
      $board.innerHTML="";
      for(const c of cards){
        const el=document.createElement("div");
        el.className="card"; el.dataset.id=c.id;
        const header=document.createElement("div");
        header.className="card-header";
        header.innerHTML=`
          <span class="drag-handle">⋮⋮</span>
          <span class="tag">${c.type==="section"?"Section":"Question"}</span>
          ${c.title?`<strong style="margin-left:6px">${escapeHtml(c.title)}</strong>`:""}
          <div class="spacer"></div>
          <button class="secondary" data-action="del">Delete</button>`;
        const body=document.createElement("div");
        body.className="card-body"; body.textContent=c.text;
        el.append(header,body); $board.appendChild(el);
      }
    }
    function getCurrentCards(){
      const order=[...$board.querySelectorAll(".card")].map(n=>n.dataset.id);
      const byId=Object.fromEntries(cards.map(c=>[c.id,c]));
      return order.map(id=>byId[id]).filter(Boolean);
    }

    // parsing (client-side); uses a CORS-friendly reader proxy for HTML
    const BULLET=/^\s*[–—-]\s+/;
    const norm=s=>(s||"").replace(/\u00a0/g," ").replace(/[ \t]+/g," ").replace(/\s*\n\s*/g,"\n").trim();

    function splitBullets(block){
      const out=[]; let buf=null;
      for(const raw of block.split(/\r?\n/)){
        const line=raw.trim(); if(!line) continue;
        if(BULLET.test(line)){ if(buf) out.push(buf.trim()); buf=line.replace(BULLET,""); }
        else if(buf){ buf+=" "+line; }
      }
      if(buf) out.push(buf.trim());
      return out;
    }
    function filterQuestions(arr){
      return arr.filter(q => /\?\s*$/.test(q) || /(read\s+colossians|based on paul|what.*risk|what.*evidence|how.*change)/i.test(q));
    }

    async function fetchGuide(url){
      // Use r.jina.ai to get readable HTML as plain text (works without CORS preflight)
      // It mirrors the page server-side and returns article content.
      const prox = url.startsWith("http") ? `https://r.jina.ai/${url}` : url;
      const res = await fetch(prox, { mode:"cors" });
      if(!res.ok) throw new Error(`Fetch ${res.status}`);
      const txt = await res.text();

      // Find "Reflect + Discuss" → block lines until next header-ish marker
      const t = norm(txt);
      const start = t.search(/reflect\s*\+\s*discuss/i);
      let block="";
      if(start>=0){
        const rest = t.slice(start);
        const m = rest.match(/reflect\s*\+\s*discuss[^\n]*\n([\s\S]*)/i);
        block = m ? m[1] : rest;
        // cut off at the next section header we know about
        const cut = block.search(/\n\s*(memorization\s*challenge|pray|next\s*steps)\b/i);
        if(cut>0) block = block.slice(0, cut);
      } else {
        block = t;
      }

      const candidates = splitBullets(block);
      const questions = filterQuestions(candidates);

      // Sections
      function grab(title){
        const re = new RegExp(`\\n\\s*${title}\\b[^\n]*\\n([\\s\\S]*?)\\n\\s*(?:memorization\\s*challenge|pray|next\\s*steps|$)`,"i");
        const m = t.match(re);
        if(!m) return null;
        return { title: title.replace(/\\s\*/g," "), body: norm(m[1]) };
      }
      const sections = ["Memorization Challenge","Pray","Next Steps"].map(grab).filter(Boolean);

      return { questions, sections };
    }

    // events
    $board.addEventListener("click",e=>{
      const btn=e.target.closest("button[data-action='del']"); if(!btn) return;
      const node=btn.closest(".card"); const id=node?.dataset.id; if(!id) return;
      cards=cards.filter(c=>c.id!==id); node.remove();
    });
    $addBtn.addEventListener("click",()=>{
      const type=$newType.value, title=$newTitle.value.trim(), text=$newText.value.trim();
      if(!text) return; const item={id:genId(),type,text}; if(type==="section"&&title) item.title=title;
      cards.push(item); renderCards(cards); $newText.value=""; $newTitle.value="";
    });
    $reset.addEventListener("click",()=>{ localStorage.removeItem("bhq-views-v2"); location.reload(); });

    $load.addEventListener("click", async ()=>{
      const url=$url.value.trim(); if(!url) return;
      $status.textContent="Loading…";
      try{
        const data=await fetchGuide(url);
        renderCards([
          ...data.questions.map(q=>({type:"question",text:q})),
          ...data.sections.map(s=>({type:"section",title:s.title,text:s.body}))
        ]);
        $status.textContent=`Loaded: ${data.questions.length} questions, ${data.sections.length} sections.`;
      }catch(err){ console.error(err); $status.textContent="Failed to load/parse."; }
    });

    function refreshViewList(){
      const names=listViews($room.value.trim());
      $sel.innerHTML=""; for(const n of names){ const o=document.createElement("option"); o.value=n; o.textContent=n; $sel.appendChild(o); }
    }
    $join.addEventListener("click",async()=>{ await joinRoom($room.value.trim(),()=>refreshViewList()); });
    $save.addEventListener("click",()=>{ const name=$name.value.trim()||"Untitled"; saveView({name, cards:getCurrentCards(), roomCode:$room.value.trim()||null}); refreshViewList(); });
    $sel.addEventListener("change",()=>{
      const name=$sel.value; const loaded=loadView({name, roomCode:$room.value.trim()||null}); if(loaded) renderCards(loaded);
    });
    refreshViewList();

    Sortable.create($board,{ animation:150, handle:".drag-handle", ghostClass:"ghost", direction:"vertical", onEnd(){ cards=getCurrentCards(); }});
  </script>
</body>
</html>
