<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Discussion Guide â€” Rooms</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0b0e;
      --panel: #12141a;
      --card: #181b24;
      --card-hover: #1e222d;
      --text: #e8ecf3;
      --muted: #7a8494;
      --accent: #6b9fff;
      --accent-glow: rgba(107, 159, 255, 0.15);
      --border: #252a38;
      --danger: #ff6b6b;
      --danger-glow: rgba(255, 107, 107, 0.15);
      --custom: #a78bfa;
      --custom-glow: rgba(167, 139, 250, 0.15);
      --edited: #f59e0b;
      --edited-glow: rgba(245, 158, 11, 0.15);
      --section: #10b981;
      --section-glow: rgba(16, 185, 129, 0.15);
      --success: #34d399;
      --success-glow: rgba(52, 211, 153, 0.2);

```
  /* Card border colors */
  --border-question: var(--accent);
  --border-custom: var(--custom);
  --border-section: var(--section);
  --border-edited: var(--edited);
}

* {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  font: 16px/1.55 'DM Sans', system-ui, -apple-system, sans-serif;
}

/* Subtle grid background */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    linear-gradient(rgba(107, 159, 255, 0.02) 1px, transparent 1px),
    linear-gradient(90deg, rgba(107, 159, 255, 0.02) 1px, transparent 1px);
  background-size: 48px 48px;
  pointer-events: none;
  z-index: 0;
}

.wrap {
  position: relative;
  z-index: 1;
  max-width: 1100px;
  margin: 28px auto 100px;
  padding: 0 20px;
}

/* Header */
header {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

header h1 {
  font-size: 24px;
  margin: 0 12px 0 0;
  font-weight: 700;
  background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.church-name {
  color: var(--muted);
  font-weight: 500;
}

/* Control bars */
.bar {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px 14px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  position: relative;
  transition: border-color 0.2s ease;
}

.bar:focus-within {
  border-color: rgba(107, 159, 255, 0.3);
}

.section-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--muted);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
}

/* Form elements */
input[type="text"], select {
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  outline: none;
  min-width: 180px;
  font-size: 15px;
  font-family: inherit;
  transition: all 0.2s ease;
}

input[type="text"]:focus, select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

select {
  cursor: pointer;
}

button {
  background: var(--accent);
  color: var(--bg);
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s ease;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px var(--accent-glow);
}

button:active {
  transform: translateY(0);
}

button.secondary {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
}

button.secondary:hover {
  background: var(--card-hover);
  box-shadow: none;
}

button.danger {
  background: var(--danger);
  color: #fff;
}

button.danger:hover {
  box-shadow: 0 4px 12px var(--danger-glow);
}

.muted { color: var(--muted); }
.spacer { flex: 1; }

/* Cards */
.board {
  display: block;
  margin-top: 8px;
  min-height: 20px;
}

.card {
  width: 100%;
  margin: 10px 0;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  position: relative;
  overflow: hidden;
  transition: all 0.25s ease;
  border-left: 3px solid var(--border-question);
}

.card:hover {
  background: var(--card-hover);
  transform: translateX(2px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.card.custom-card {
  border-left-color: var(--border-custom);
}

.card.section-card {
  border-left-color: var(--border-section);
  background: linear-gradient(135deg, var(--card) 0%, rgba(16, 185, 129, 0.05) 100%);
}

.card.edited-card {
  border-left-color: var(--border-edited);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
}

.drag-handle {
  cursor: grab;
  user-select: none;
  font-weight: 900;
  letter-spacing: 2px;
  opacity: 0.3;
  transition: opacity 0.2s ease;
  padding: 4px;
}

.card:hover .drag-handle {
  opacity: 0.7;
}

.drag-handle:hover {
  opacity: 1 !important;
}

.tag {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 6px;
  background: var(--accent-glow);
  color: var(--accent);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tag.custom {
  background: var(--custom-glow);
  color: var(--custom);
}

.tag.edited {
  background: var(--edited-glow);
  color: var(--edited);
}

.tag.section {
  background: var(--section-glow);
  color: var(--section);
}

.card-body {
  padding: 14px 16px;
  white-space: pre-wrap;
  font-size: 15px;
  line-height: 1.65;
}

.section-card .card-body {
  font-size: 16px;
  font-weight: 500;
}

.ghost {
  opacity: 0.4;
  transform: rotate(1deg);
}

.row {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.row > * { flex: 0 0 auto; }
.row .grow { flex: 1 1 240px; min-width: 240px; }

.hint {
  margin-top: 10px;
  font-size: 13px;
}

.footer {
  margin-top: 24px;
  color: var(--muted);
  font-size: 13px;
  opacity: 0.7;
}

/* Collapsible board sections */
.boards {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 16px;
}

.board-wrap {
  background: transparent;
}

.board-header {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  padding: 8px 0;
  user-select: none;
  transition: opacity 0.2s ease;
}

.board-header:hover {
  opacity: 0.8;
}

.board-title {
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.board-title .count {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
  background: var(--card);
  padding: 2px 8px;
  border-radius: 10px;
}

.board-toggle {
  font-size: 12px;
  color: var(--muted);
  transition: transform 0.3s ease;
}

.board-wrap.collapsed .board-toggle {
  transform: rotate(-90deg);
}

.board-wrap.collapsed .board {
  display: none;
}

.board-muted .card {
  opacity: 0.7;
}

.board-muted .card:hover {
  opacity: 1;
}

.board-muted .drag-handle {
  opacity: 0.2;
  cursor: default;
}

/* Icon buttons */
.icon-btn {
  background: transparent;
  color: var(--muted);
  border: 1px solid transparent;
  border-radius: 8px;
  padding: 6px 8px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  transition: all 0.2s ease;
}

.icon-btn:hover {
  background: var(--card);
  border-color: var(--border);
  color: var(--text);
  transform: none;
  box-shadow: none;
}

.icon-btn.danger:hover {
  background: var(--danger-glow);
  border-color: rgba(255, 107, 107, 0.3);
  color: var(--danger);
}

.icon-btn.success:hover {
  background: var(--success-glow);
  border-color: rgba(52, 211, 153, 0.3);
  color: var(--success);
}

.icon-btn svg {
  width: 16px;
  height: 16px;
  display: block;
}

/* PDF link button */
#pdfLink, #pdfLink:link, #pdfLink:visited {
  color: var(--text);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  display: inline-block;
  text-decoration: none;
  font-weight: 500;
  font-size: 14px;
  transition: all 0.2s ease;
}

#pdfLink:hover {
  background: var(--card-hover);
  border-color: var(--accent);
}

/* Edit mode */
.card.editing .card-body { display: none; }
.card:not(.editing) .edit-area { display: none; }

.edit-area {
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.edit-area textarea {
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  font-family: inherit;
  font-size: 15px;
  line-height: 1.55;
  min-height: 100px;
  resize: vertical;
  outline: none;
  transition: all 0.2s ease;
}

.edit-area textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.edit-area .edit-controls {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

.edit-area .edit-controls button {
  padding: 8px 14px;
  font-size: 14px;
}

/* Bible verses section */
.card-verses {
  border-top: 1px solid var(--border);
  background: rgba(107, 159, 255, 0.02);
}

.verses-header {
  padding: 12px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s ease;
}

.verses-header:hover {
  background: rgba(107, 159, 255, 0.04);
}

.verses-icon {
  font-size: 16px;
}

.verses-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--accent);
  flex: 1;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.verses-toggle {
  font-size: 12px;
  color: var(--muted);
  transition: transform 0.3s ease;
}

.verses-content {
  padding: 0 14px 14px 14px;
  max-height: 0;
  overflow: hidden;
  transition: all 0.3s ease;
}

.verses-content.visible {
  max-height: 2000px;
}

.verse-block {
  margin-bottom: 16px;
}

.verse-block:last-child {
  margin-bottom: 0;
}

.verse-reference {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 6px;
}

.verse-text {
  font-size: 14px;
  line-height: 1.7;
  color: var(--text);
  font-style: italic;
  padding-left: 14px;
  border-left: 2px solid var(--accent);
  opacity: 0.9;
}

.verse-loading {
  font-size: 13px;
  color: var(--muted);
  font-style: italic;
}

.verse-error {
  font-size: 13px;
  color: var(--danger);
  font-style: italic;
}

/* Title input */
#newTitle {
  display: none;
}

#newTitle.visible {
  display: block;
}

/* Auto-expanding textarea for new questions */
#newText {
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  outline: none;
  font-size: 15px;
  font-family: inherit;
  line-height: 1.5;
  resize: none;
  overflow: hidden;
  min-height: 42px;
  max-height: 200px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#newText:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

/* Search filter bar */
.filter-bar {
  margin-top: 10px;
  display: flex;
  gap: 10px;
  align-items: center;
}

.filter-bar input {
  flex: 1;
  min-width: 200px;
}

.filter-bar .filter-count {
  color: var(--muted);
  font-size: 12px;
  white-space: nowrap;
}

/* Hidden filtered cards */
.card.filtered {
  display: none;
}

/* Edited badge */
.edited-badge {
  font-size: 9px;
  padding: 3px 6px;
  border-radius: 4px;
  background: var(--edited);
  color: #fff;
  font-weight: 700;
  letter-spacing: 0.5px;
}

/* Hamburger menu */
.menu-toggle {
  position: relative;
}

.menu-toggle > button {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
  padding: 8px 12px;
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
}

.menu-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 6px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 6px;
  display: none;
  flex-direction: column;
  gap: 2px;
  min-width: 200px;
  z-index: 1000;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  animation: menuSlide 0.2s ease;
}

@keyframes menuSlide {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.menu-dropdown.visible {
  display: flex;
}

.menu-dropdown button {
  background: transparent;
  color: var(--text);
  border: none;
  padding: 12px 14px;
  text-align: left;
  border-radius: 8px;
  font-weight: 500;
  font-size: 14px;
}

.menu-dropdown button:hover {
  background: var(--card);
  transform: none;
  box-shadow: none;
}

.menu-dropdown button.danger {
  color: var(--danger);
  background: transparent;
}

.menu-dropdown button.danger:hover {
  background: var(--danger-glow);
}

/* Sermon date */
.sermon-date {
  font-size: 12px;
  color: var(--muted);
  font-style: italic;
  white-space: nowrap;
}

/* Keyboard shortcuts help */
.shortcuts-help {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 18px;
  display: none;
  max-width: 320px;
  z-index: 1000;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  animation: helpSlide 0.25s ease;
}

@keyframes helpSlide {
  from {
    opacity: 0;
    transform: translateY(16px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.shortcuts-help.visible {
  display: block;
}

.shortcuts-help h3 {
  margin: 0 0 14px 0;
  font-size: 14px;
  color: var(--text);
  font-weight: 600;
}

.shortcuts-help .shortcut {
  display: flex;
  justify-content: space-between;
  margin: 8px 0;
  font-size: 13px;
  color: var(--muted);
}

.shortcuts-help .key {
  background: var(--card);
  padding: 4px 10px;
  border-radius: 6px;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 11px;
  color: var(--text);
  border: 1px solid var(--border);
}

.shortcuts-help .close-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: transparent;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 4px;
  font-size: 18px;
  line-height: 1;
}

.shortcuts-help .close-btn:hover {
  color: var(--text);
  transform: none;
  box-shadow: none;
}

/* Toast notifications */
.toast-container {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
}

.toast {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  animation: toastIn 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  pointer-events: auto;
}

.toast.success {
  border-color: rgba(52, 211, 153, 0.3);
}

.toast.success::before {
  content: 'âœ“';
  color: var(--success);
  font-weight: bold;
}

.toast.warning {
  border-color: rgba(245, 158, 11, 0.3);
}

.toast.warning::before {
  content: 'âš ';
  color: var(--edited);
}

.toast.hiding {
  animation: toastOut 0.3s ease forwards;
}

@keyframes toastIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes toastOut {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-20px);
  }
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.empty-state svg {
  width: 80px;
  height: 80px;
  margin-bottom: 20px;
  opacity: 0.4;
}

.empty-state h3 {
  font-size: 18px;
  color: var(--text);
  margin: 0 0 8px 0;
  font-weight: 600;
}

.empty-state p {
  font-size: 14px;
  margin: 0 0 20px 0;
  max-width: 320px;
  margin-left: auto;
  margin-right: auto;
}

/* Swipe hint on mobile - removed */
.swipe-hint {
  display: none;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  html, body {
    font-size: 16px;
  }
  
  .wrap {
    padding: 0 14px;
    margin: 16px auto 80px;
  }
  
  header h1 {
    font-size: 20px;
  }
  
  .bar {
    padding: 10px 12px;
    gap: 8px;
    border-radius: 12px;
  }
  
  button {
    padding: 10px 14px;
    font-size: 14px;
  }
  
  input[type="text"], select {
    min-width: 120px;
    font-size: 16px;
    padding: 10px 12px;
  }
  
  .card {
    border-radius: 12px;
    margin: 8px 0;
  }
  
  .card-body {
    padding: 14px;
    font-size: 15px;
    line-height: 1.6;
  }
  
  .edit-area textarea {
    font-size: 16px;
    padding: 12px;
  }
  
  .shortcuts-help {
    right: 12px;
    bottom: 12px;
    max-width: calc(100vw - 48px);
  }
  
  .menu-dropdown {
    right: 0;
    min-width: 180px;
  }
  
  .swipe-hint {
    display: block;
  }
  
  .toast-container {
    left: 14px;
    right: 14px;
    transform: none;
  }
  
  .toast {
    width: 100%;
  }
}
```

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Discussion Guide</h1>
      <span class="church-name">Blackhawk Church</span>
    </header>

```
<!-- Room Details -->
<div class="section-title">Room Details</div>
<div class="bar">
  <select id="roomSelect" title="Rooms"></select>
  <input id="roomInput" type="text" placeholder="New room nameâ€¦" />
  <button id="createJoinBtn">Create / Join</button>

  <a id="pdfLink" href="#" target="_blank" rel="noopener" style="display:none">Open PDF</a>

  <div class="spacer"></div>
  
  <span class="sermon-date" id="sermonDate"></span>
  <button id="loadLatestBtn" class="secondary" title="Load from data/guide.json">Load Latest Sermon</button>
  
  <!-- Hamburger Menu -->
  <div class="menu-toggle">
    <button id="menuToggle" title="More options">â˜°</button>
    <div class="menu-dropdown" id="menuDropdown">
      <button id="shareBtn" class="secondary">Copy Share Link</button>
      <button id="refreshBtn" class="secondary">Refresh</button>
      <button id="helpBtn" class="secondary">Keyboard Shortcuts</button>
      <button id="deleteRoomBtn" class="danger">Delete Room</button>
    </div>
  </div>
  
  <span class="muted" id="status"></span>
</div>

<!-- Search -->
<div class="section-title" style="margin-top:18px">Search</div>
<div class="bar filter-bar">
  <input id="searchInput" type="text" placeholder="Search questions..." />
  <button id="clearSearchBtn" class="secondary">Clear</button>
  <span class="filter-count" id="filterCount"></span>
</div>

<!-- Add Custom Questions -->
<div class="section-title" style="margin-top:18px">Add Custom Questions</div>
<div class="bar">
  <select id="newType">
    <option value="question">Question</option>
    <option value="section">Section</option>
  </select>
  <input id="newTitle" type="text" placeholder="Section title" />
  <textarea id="newText" class="grow" placeholder="Type hereâ€¦" rows="1"></textarea>
  <button id="addBtn">Add</button>
</div>

<!-- Boards -->
<div class="boards">
  <!-- Active Board -->
  <div class="board-wrap" id="activeWrap">
    <div class="board-header" data-board="active">
      <span class="board-toggle">â–¼</span>
      <div class="board-title">
        Active
        <span class="count" id="activeCount">0</span>
      </div>
    </div>
    <div id="boardActive" class="board"></div>
  </div>
  
  <!-- Completed Board -->
  <div class="board-wrap collapsed" id="doneWrap">
    <div class="board-header" data-board="done">
      <span class="board-toggle">â–¼</span>
      <div class="board-title">
        Completed
        <span class="count" id="doneCount">0</span>
      </div>
    </div>
    <div id="boardDone" class="board board-muted"></div>
  </div>
  
  <!-- Deleted Board -->
  <div class="board-wrap collapsed" id="deletedWrap">
    <div class="board-header" data-board="deleted">
      <span class="board-toggle">â–¼</span>
      <div class="board-title">
        Deleted
        <span class="count" id="deletedCount">0</span>
      </div>
    </div>
    <div id="boardDeleted" class="board board-muted"></div>
  </div>
</div>

<!-- Empty State -->
<div class="empty-state" id="emptyState" style="display: none;">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
  </svg>
  <h3>No discussion questions yet</h3>
  <p>Click "Load Latest Sermon" to get started with this week's discussion guide.</p>
  <button id="emptyLoadBtn">Load Latest Sermon</button>
</div>

<div class="hint muted" id="hintText">Press <strong>?</strong> for keyboard shortcuts</div>
<div class="footer">blackhawk.church/learn</div>
```

  </div>

  <!-- Toast Container -->

  <div class="toast-container" id="toastContainer"></div>

  <!-- Keyboard shortcuts help panel -->

  <div class="shortcuts-help" id="shortcutsHelp">
    <button class="close-btn" id="closeHelp">&times;</button>
    <h3>Keyboard Shortcuts</h3>
    <div class="shortcut">
      <span>Show/hide help</span>
      <span class="key">?</span>
    </div>
    <div class="shortcut">
      <span>Search</span>
      <span class="key">/</span>
    </div>
    <div class="shortcut">
      <span>Clear search</span>
      <span class="key">Esc</span>
    </div>
    <div class="shortcut">
      <span>Add new card</span>
      <span class="key">n</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" crossorigin="anonymous"></script>

  <script type="module">
    import { connectFirebase, joinRoom, saveLive, loadLive, listRooms, currentRoomCode, deleteRoom } from "./static/js/viewStore.js";

    // ---- Firebase (paste your config) ----
    const FIREBASE_ENABLED = true;
    const firebaseConfig = {
      apiKey: "AIzaSyBMtVbKp6i5cnb_Zapc_sEW8rMebVjuIKs",
      authDomain: "blackhawk-discussion-guide.firebaseapp.com",
      projectId: "blackhawk-discussion-guide",
    };
    if (FIREBASE_ENABLED) { await connectFirebase(firebaseConfig); }

    // ---- Toast Notifications ----
    function showToast(message, type = 'success', duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ---- Bible Verse Detection & Fetching ----
    const verseCache = {};
    const ESV_WORKER_URL = 'https://esv-bible-proxy.johnston-thayer.workers.dev';

    const bookMappings = {
      // Old Testament
      'gen': 'Genesis', 'genesis': 'Genesis',
      'ex': 'Exodus', 'exo': 'Exodus', 'exod': 'Exodus', 'exodus': 'Exodus',
      'lev': 'Leviticus', 'leviticus': 'Leviticus',
      'num': 'Numbers', 'numbers': 'Numbers',
      'deut': 'Deuteronomy', 'dt': 'Deuteronomy', 'deuteronomy': 'Deuteronomy',
      'josh': 'Joshua', 'joshua': 'Joshua',
      'judg': 'Judges', 'judges': 'Judges',
      'ruth': 'Ruth',
      '1 sam': '1 Samuel', '1 samuel': '1 Samuel', '1sam': '1 Samuel',
      '2 sam': '2 Samuel', '2 samuel': '2 Samuel', '2sam': '2 Samuel',
      '1 kings': '1 Kings', '1 ki': '1 Kings', '1ki': '1 Kings',
      '2 kings': '2 Kings', '2 ki': '2 Kings', '2ki': '2 Kings',
      '1 chron': '1 Chronicles', '1 chronicles': '1 Chronicles', '1chron': '1 Chronicles',
      '2 chron': '2 Chronicles', '2 chronicles': '2 Chronicles', '2chron': '2 Chronicles',
      'ezra': 'Ezra',
      'neh': 'Nehemiah', 'nehemiah': 'Nehemiah',
      'esth': 'Esther', 'esther': 'Esther',
      'job': 'Job',
      'ps': 'Psalm', 'psa': 'Psalm', 'psalm': 'Psalm', 'psalms': 'Psalm',
      'prov': 'Proverbs', 'proverbs': 'Proverbs',
      'eccl': 'Ecclesiastes', 'ecclesiastes': 'Ecclesiastes',
      'song': 'Song of Solomon', 'song of solomon': 'Song of Solomon',
      'isa': 'Isaiah', 'isaiah': 'Isaiah',
      'jer': 'Jeremiah', 'jeremiah': 'Jeremiah',
      'lam': 'Lamentations', 'lamentations': 'Lamentations',
      'ezek': 'Ezekiel', 'ezekiel': 'Ezekiel',
      'dan': 'Daniel', 'daniel': 'Daniel',
      'hos': 'Hosea', 'hosea': 'Hosea',
      'joel': 'Joel',
      'amos': 'Amos',
      'obad': 'Obadiah', 'obadiah': 'Obadiah',
      'jonah': 'Jonah',
      'mic': 'Micah', 'micah': 'Micah',
      'nah': 'Nahum', 'nahum': 'Nahum',
      'hab': 'Habakkuk', 'habakkuk': 'Habakkuk',
      'zeph': 'Zephaniah', 'zephaniah': 'Zephaniah',
      'hag': 'Haggai', 'haggai': 'Haggai',
      'zech': 'Zechariah', 'zechariah': 'Zechariah',
      'mal': 'Malachi', 'malachi': 'Malachi',
      // New Testament
      'matt': 'Matthew', 'mt': 'Matthew', 'matthew': 'Matthew',
      'mark': 'Mark', 'mk': 'Mark',
      'luke': 'Luke', 'lk': 'Luke',
      'john': 'John', 'jn': 'John',
      'acts': 'Acts',
      'rom': 'Romans', 'romans': 'Romans',
      '1 cor': '1 Corinthians', '1 corinthians': '1 Corinthians', '1cor': '1 Corinthians',
      '2 cor': '2 Corinthians', '2 corinthians': '2 Corinthians', '2cor': '2 Corinthians',
      'gal': 'Galatians', 'galatians': 'Galatians',
      'eph': 'Ephesians', 'ephesians': 'Ephesians',
      'phil': 'Philippians', 'php': 'Philippians', 'philippians': 'Philippians',
      'col': 'Colossians', 'colossians': 'Colossians',
      '1 thess': '1 Thessalonians', '1 thessalonians': '1 Thessalonians', '1thess': '1 Thessalonians',
      '2 thess': '2 Thessalonians', '2 thessalonians': '2 Thessalonians', '2thess': '2 Thessalonians',
      '1 tim': '1 Timothy', '1 timothy': '1 Timothy', '1tim': '1 Timothy',
      '2 tim': '2 Timothy', '2 timothy': '2 Timothy', '2tim': '2 Timothy',
      'titus': 'Titus',
      'philem': 'Philemon', 'philemon': 'Philemon',
      'heb': 'Hebrews', 'hebrews': 'Hebrews',
      'james': 'James', 'jas': 'James',
      '1 pet': '1 Peter', '1 peter': '1 Peter', '1pet': '1 Peter',
      '2 pet': '2 Peter', '2 peter': '2 Peter', '2pet': '2 Peter',
      '1 john': '1 John', '1john': '1 John', '1 jn': '1 John',
      '2 john': '2 John', '2john': '2 John', '2 jn': '2 John',
      '3 john': '3 John', '3john': '3 John', '3 jn': '3 John',
      'jude': 'Jude',
      'rev': 'Revelation', 'revelation': 'Revelation'
    };

    function detectVerseReferences(text) {
      const pattern = /\b((?:1|2|3)\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?\.?)\s+(\d+):(\d+)(?:-(\d+))?\b/gi;
      const references = [];
      const seen = new Set();

      let match;
      while ((match = pattern.exec(text)) !== null) {
        const prefix = match[1] ? match[1].trim() + ' ' : '';
        const bookRaw = match[2].replace(/\.$/, '');
        const chapter = match[3];
        const verseStart = match[4];
        const verseEnd = match[5] || verseStart;

        let bookKey = (prefix + bookRaw).toLowerCase();
        let normalizedBook = bookMappings[bookKey];
        
        if (!normalizedBook && bookRaw.includes(' ')) {
          const words = bookRaw.split(/\s+/);
          const lastWord = words[words.length - 1];
          bookKey = (prefix + lastWord).toLowerCase();
          normalizedBook = bookMappings[bookKey];
        }
        
        if (!normalizedBook) continue;

        const reference = `${normalizedBook} ${chapter}:${verseStart}${verseEnd !== verseStart ? '-' + verseEnd : ''}`;
        const key = reference.toLowerCase();

        if (!seen.has(key)) {
          seen.add(key);
          references.push({
            reference,
            apiReference: `${normalizedBook}+${chapter}:${verseStart}-${verseEnd}`
          });
        }
      }

      return references;
    }

    async function fetchVerse(apiReference) {
      if (verseCache[apiReference]) {
        return verseCache[apiReference];
      }

      try {
        const query = apiReference.replace(/\+/g, ' ');
        const response = await fetch(`${ESV_WORKER_URL}?q=${encodeURIComponent(query)}`);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
        const result = {
          text: data.passages[0].trim(),
          reference: query
        };

        verseCache[apiReference] = result;
        return result;
      } catch (error) {
        console.error('Error fetching verse:', error);
        return { error: true, message: 'Unable to load verse' };
      }
    }

    // ---- DOM ----
    const $roomSel = document.getElementById("roomSelect");
    const $roomInp = document.getElementById("roomInput");
    const $createJoin = document.getElementById("createJoinBtn");
    const $share = document.getElementById("shareBtn");
    const $status = document.getElementById("status");
    const $pdfLink = document.getElementById("pdfLink");
    const $sermonDate = document.getElementById("sermonDate");

    const $boardActive  = document.getElementById("boardActive");
    const $boardDone    = document.getElementById("boardDone");
    const $boardDeleted = document.getElementById("boardDeleted");
    const $boards       = document.querySelector(".boards");

    const $addBtn = document.getElementById("addBtn");
    const $newType = document.getElementById("newType");
    const $newTitle= document.getElementById("newTitle");
    const $newText = document.getElementById("newText");

    const $deleteRoom = document.getElementById("deleteRoomBtn");
    const $loadLatest = document.getElementById("loadLatestBtn");
    const $refresh = document.getElementById("refreshBtn");

    const $searchInput = document.getElementById("searchInput");
    const $clearSearch = document.getElementById("clearSearchBtn");
    const $filterCount = document.getElementById("filterCount");

    const $helpBtn = document.getElementById("helpBtn");
    const $shortcutsHelp = document.getElementById("shortcutsHelp");
    const $closeHelp = document.getElementById("closeHelp");

    const $menuToggle = document.getElementById("menuToggle");
    const $menuDropdown = document.getElementById("menuDropdown");

    const $activeCount = document.getElementById("activeCount");
    const $doneCount = document.getElementById("doneCount");
    const $deletedCount = document.getElementById("deletedCount");

    const $emptyState = document.getElementById("emptyState");
    const $emptyLoadBtn = document.getElementById("emptyLoadBtn");
    const $hintText = document.getElementById("hintText");

    // ---- Board collapse toggle ----
    document.querySelectorAll('.board-header').forEach(header => {
      header.addEventListener('click', () => {
        const wrap = header.closest('.board-wrap');
        wrap.classList.toggle('collapsed');
      });
    });

    // ---- Hamburger menu ----
    $menuToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      $menuDropdown.classList.toggle("visible");
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".menu-toggle")) {
        $menuDropdown.classList.remove("visible");
      }
    });

    $menuDropdown.addEventListener("click", () => {
      $menuDropdown.classList.remove("visible");
    });

    // ---- Icons ----
    const ICONS = {
      check: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 6L9 17l-5-5" />
        </svg>`,
      trash: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18" />
          <path d="M8 6V4h8v2" />
          <path d="M19 6l-1 14H6L5 6" />
          <path d="M10 11v6M14 11v6" />
        </svg>`,
      undo: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 9l-4 4 4 4" />
          <path d="M3 13h9a6 6 0 016 6" />
        </svg>`,
      edit: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
        </svg>`
    };

    // ---- State ----
    let cards = [];
    let currentSermonDate = null;
    let currentPdfUrl = null;
    const genId = () => "c_" + Math.random().toString(36).slice(2,9);
    let searchQuery = "";

    $newType.addEventListener("change", () => {
      if ($newType.value === "section") {
        $newTitle.classList.add("visible");
      } else {
        $newTitle.classList.remove("visible");
        $newTitle.value = "";
      }
    });

    // Auto-expand textarea as user types
    function autoExpandTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }
    
    $newText.addEventListener('input', () => autoExpandTextarea($newText));
    
    // Also handle paste events
    $newText.addEventListener('paste', () => {
      setTimeout(() => autoExpandTextarea($newText), 0);
    });

    function updateSermonDate(dateStr) {
      if (dateStr) {
        currentSermonDate = dateStr;
        $sermonDate.textContent = dateStr;
        $sermonDate.style.display = "inline";
      } else {
        currentSermonDate = null;
        $sermonDate.textContent = "";
        $sermonDate.style.display = "none";
      }
    }
    
    function updatePdfLink(url) {
      currentPdfUrl = url;
      if (!url) { 
        $pdfLink.style.display = "none";
        return;
      }
      var isPdf = url.toLowerCase().endsWith(".pdf");
      $pdfLink.textContent = isPdf ? "Open PDF" : "Open Source Page";
      $pdfLink.href = url;
      $pdfLink.style.display = "inline-block";
    }

    function updateCardCounts() {
      const active = cards.filter(c => c.status === 'active').length;
      const done = cards.filter(c => c.status === 'done').length;
      const deleted = cards.filter(c => c.status === 'deleted').length;
      
      $activeCount.textContent = active;
      $doneCount.textContent = done;
      $deletedCount.textContent = deleted;
      
      // Show/hide empty state
      if (cards.length === 0) {
        $emptyState.style.display = 'block';
        $hintText.style.display = 'none';
      } else {
        $emptyState.style.display = 'none';
        $hintText.style.display = 'block';
      }
    }

    function updateFilterCount() {
      if (!searchQuery) {
        $filterCount.textContent = "";
        return;
      }
      const visible = cards.filter(c => {
        const text = (c.text || "").toLowerCase();
        const title = (c.title || "").toLowerCase();
        const query = searchQuery.toLowerCase();
        return text.includes(query) || title.includes(query);
      }).length;
      $filterCount.textContent = `Showing ${visible} of ${cards.length}`;
    }

    function applySearch() {
      const query = searchQuery.toLowerCase();
      document.querySelectorAll(".card").forEach(cardEl => {
        if (!query) {
          cardEl.classList.remove("filtered");
          return;
        }
        const id = cardEl.dataset.id;
        const card = cards.find(c => c.id === id);
        if (!card) {
          cardEl.classList.add("filtered");
          return;
        }
        const text = (card.text || "").toLowerCase();
        const title = (card.title || "").toLowerCase();
        const matches = text.includes(query) || title.includes(query);
        if (matches) {
          cardEl.classList.remove("filtered");
        } else {
          cardEl.classList.add("filtered");
        }
      });
      updateFilterCount();
    }

    async function createVersesSection(text) {
      const references = detectVerseReferences(text);
      
      if (references.length === 0) return null;

      const versesDiv = document.createElement("div");
      versesDiv.className = "card-verses";

      const header = document.createElement("div");
      header.className = "verses-header";
      header.innerHTML = `
        <span class="verses-icon">ðŸ“–</span>
        <span class="verses-title">Bible Verses (${references.length})</span>
        <span class="verses-toggle">â–¼</span>
      `;

      const content = document.createElement("div");
      content.className = "verses-content";

      header.addEventListener("click", () => {
        content.classList.toggle("visible");
        const toggle = header.querySelector(".verses-toggle");
        toggle.style.transform = content.classList.contains("visible") 
          ? "rotate(0deg)" 
          : "rotate(-90deg)";
      });

      versesDiv.appendChild(header);
      versesDiv.appendChild(content);

      for (const ref of references) {
        const block = document.createElement("div");
        block.className = "verse-block";

        const refTitle = document.createElement("div");
        refTitle.className = "verse-reference";
        refTitle.textContent = ref.reference;

        const verseText = document.createElement("div");
        verseText.className = "verse-text verse-loading";
        verseText.textContent = "Loading...";

        block.appendChild(refTitle);
        block.appendChild(verseText);
        content.appendChild(block);

        fetchVerse(ref.apiReference).then(result => {
          if (result.error) {
            verseText.className = "verse-text verse-error";
            verseText.textContent = result.message;
          } else {
            verseText.className = "verse-text";
            verseText.textContent = result.text;
          }
        });
      }

      return versesDiv;
    }

    async function renderCards(next) {
      cards = next.map(c => ({ 
        status: 'active', 
        source: 'pdf',
        ...c, 
        id: c.id || genId() 
      }));

      $boardActive.innerHTML  = "";
      $boardDone.innerHTML    = "";
      $boardDeleted.innerHTML = "";

      for (const c of cards) {
        const el = document.createElement("div");
        el.className = "card";
        el.dataset.id = c.id;

        const isEdited = c.originalText && c.originalText !== c.text;
        const isCustom = c.source === "custom";
        const isSection = c.type === "section";

        // Add card type classes
        if (isCustom) el.classList.add('custom-card');
        if (isSection) el.classList.add('section-card');
        if (isEdited && !isCustom) el.classList.add('edited-card');

        const header = document.createElement("div");
        header.className = "card-header";
        
        let tagClass = "";
        let tagText = isSection ? "Section" : "Question";
        if (isCustom) {
          tagClass = "custom";
          tagText = isSection ? "Custom Section" : "Custom";
        } else if (isSection) {
          tagClass = "section";
        } else if (isEdited) {
          tagClass = "edited";
        }

        header.innerHTML = `
          <span class="drag-handle">â‹®â‹®</span>
          <span class="tag ${tagClass}">${tagText}</span>
          ${c.title ? `<strong style="margin-left:6px">${escapeHtml(c.title)}</strong>` : ""}
          ${isEdited ? '<span class="edited-badge">EDITED</span>' : ''}
          <div class="spacer"></div>
          ${c.status === 'active' ? `
            <button class="icon-btn" data-action="edit" title="Edit" aria-label="Edit">
              ${ICONS.edit}
            </button>
            <button class="icon-btn success" data-action="complete" title="Mark complete" aria-label="Mark complete">
              ${ICONS.check}
            </button>
            <button class="icon-btn danger" data-action="trash" title="Move to deleted" aria-label="Move to deleted">
              ${ICONS.trash}
            </button>
          ` : `
            <button class="icon-btn" data-action="undo" title="Move back to active" aria-label="Undo">
              ${ICONS.undo}
            </button>
          `}
        `;
        
        const body = document.createElement("div");
        body.className = "card-body";
        body.textContent = c.text;

        const editArea = document.createElement("div");
        editArea.className = "edit-area";
        editArea.innerHTML = `
          <textarea class="edit-textarea">${escapeHtml(c.text)}</textarea>

```
      <div class="edit-controls">
        <button class="secondary" data-action="cancel-edit">Cancel</button>
        <button data-action="save-edit">Save</button>
      </div>
    `;

    el.appendChild(header);
    el.appendChild(body);
    el.appendChild(editArea);

    const versesSection = await createVersesSection(c.text);
    if (versesSection) {
      el.appendChild(versesSection);
    }

    if (c.status === "done") $boardDone.appendChild(el);
    else if (c.status === "deleted") $boardDeleted.appendChild(el);
    else $boardActive.appendChild(el);
  }

  updateCardCounts();
  applySearch();
}

function getCurrentCards() {
  const byId = Object.fromEntries(cards.map(c => [c.id, c]));
  const read = (container, status) =>
    [...container.querySelectorAll(".card")].map(n => {
      const id = n.dataset.id;
      return { ...byId[id], status };
    });
  return [
    ...read($boardActive,  'active'),
    ...read($boardDone,    'done'),
    ...read($boardDeleted, 'deleted'),
  ];
}

Sortable.create($boardActive, {
  animation: 150,
  handle: ".drag-handle",
  ghostClass: "ghost",
  direction: "vertical",
  onEnd() { cards = getCurrentCards(); autoSave(); }
});

const debounce = (fn, ms = 400) => {
  let t;
  return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
};

const autoSave = debounce(function() {
  if (!currentRoomCode()) return;
  var saveData = {
    cards: getCurrentCards(),
    meta: {
      pdfUrl: currentPdfUrl,
      sermonDate: currentSermonDate
    }
  };
  saveLive(saveData);
}, 400);

document.querySelector(".boards").addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-action]");
  if (!btn) return;

  const card = btn.closest(".card");
  if (!card) return;
  
  const id = card.dataset.id;
  const action = btn.dataset.action;

  if (action === "edit") {
    card.classList.add("editing");
    const textarea = card.querySelector(".edit-textarea");
    if (textarea) {
      textarea.focus();
      textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    }
    return;
  }

  if (action === "cancel-edit") {
    card.classList.remove("editing");
    const originalCard = cards.find(c => c.id === id);
    if (originalCard) {
      const textarea = card.querySelector(".edit-textarea");
      if (textarea) textarea.value = originalCard.text;
    }
    return;
  }

  if (action === "save-edit") {
    const textarea = card.querySelector(".edit-textarea");
    if (!textarea) return;
    
    const newText = textarea.value.trim();
    if (!newText) {
      showToast("Card text cannot be empty", "warning");
      return;
    }

    const current = getCurrentCards();
    const next = current.map(c => {
      if (c.id !== id) return c;
      const originalText = c.originalText || (c.source === 'pdf' ? c.text : undefined);
      return { ...c, text: newText, originalText };
    });
    
    renderCards(next);
    autoSave();
    showToast("Changes saved", "success");
    return;
  }

  let newStatus;
  let toastMsg;
  if (action === "complete") {
    newStatus = "done";
    toastMsg = "Marked as complete";
  } else if (action === "trash") {
    newStatus = "deleted";
    toastMsg = "Moved to deleted";
  } else if (action === "undo") {
    newStatus = "active";
    toastMsg = "Restored to active";
  } else {
    return;
  }

  const current = getCurrentCards();
  const next = current.map(c => (c.id === id ? { ...c, status: newStatus } : c));

  renderCards(next);
  autoSave();
  showToast(toastMsg, action === "trash" ? "warning" : "success");
});

document.getElementById("addBtn").addEventListener("click", () => {
  const type = $newType.value;
  const title = ($newTitle.value || "").trim();
  const text = ($newText.value || "").trim();
  if (!text) return;
  
  const item = { 
    id: genId(), 
    type, 
    text, 
    status: "active",
    source: "custom"
  };
  if (type === "section" && title) item.title = title;
  
  renderCards([item, ...cards]);
  $newText.value = "";
  $newText.style.height = 'auto'; // Reset height after clearing
  $newTitle.value = "";
  autoSave();
  showToast("Card added", "success");
});

$searchInput.addEventListener("input", (e) => {
  searchQuery = e.target.value;
  applySearch();
});

$clearSearch.addEventListener("click", () => {
  searchQuery = "";
  $searchInput.value = "";
  applySearch();
});

document.addEventListener("keydown", (e) => {
  if (e.target.matches("input, textarea")) {
    if (e.key === "Escape" && e.target === $searchInput) {
      $clearSearch.click();
      $searchInput.blur();
    }
    return;
  }

  if (e.key === "?") {
    e.preventDefault();
    $shortcutsHelp.classList.toggle("visible");
    return;
  }

  if (e.key === "/") {
    e.preventDefault();
    $searchInput.focus();
    return;
  }

  if (e.key === "Escape") {
    e.preventDefault();
    $shortcutsHelp.classList.remove("visible");
    $clearSearch.click();
    return;
  }

  if (e.key === "n" || e.key === "N") {
    e.preventDefault();
    $newText.focus();
    return;
  }
});

$helpBtn.addEventListener("click", () => {
  $shortcutsHelp.classList.toggle("visible");
});

$closeHelp.addEventListener("click", () => {
  $shortcutsHelp.classList.remove("visible");
});

async function refreshRoomsList(selected) {
  const rooms = await listRooms();
  $roomSel.innerHTML = "";
  for (const r of rooms) {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    $roomSel.appendChild(opt);
  }
  if (selected && rooms.includes(selected)) $roomSel.value = selected;
}

async function joinAndLoad(room) {
  await joinRoom(room, function() {
    var state = loadLive();
    if (Array.isArray(state)) {
      renderCards(state);
    } else {
      renderCards(state.cards || []);
      if (state.meta) {
        updatePdfLink(state.meta.pdfUrl);
        updateSermonDate(state.meta.sermonDate);
      }
    }
    $status.textContent = currentRoomCode()
      ? "Connected: " + currentRoomCode()
      : "Local mode";
  });
  await refreshRoomsList(currentRoomCode());
  var state = loadLive();
  if (Array.isArray(state)) {
    renderCards(state);
  } else {
    renderCards(state.cards || []);
    if (state.meta) {
      updatePdfLink(state.meta.pdfUrl);
      updateSermonDate(state.meta.sermonDate);
    }
  }
}

const urlRoom = new URLSearchParams(location.search).get("room");
await joinAndLoad(urlRoom || null);
await refreshRoomsList(currentRoomCode());

$createJoin.addEventListener("click", async () => {
  const name = ($roomInp.value || "").trim();
  if (!name) return;
  await joinAndLoad(name);
  const url = new URL(location.href);
  url.searchParams.set("room", name);
  history.replaceState(null, "", url.toString());
  showToast(`Joined room: ${name}`, "success");
});

$roomSel.addEventListener("change", async () => {
  const name = $roomSel.value;
  await joinAndLoad(name);
  const url = new URL(location.href);
  url.searchParams.set("room", name);
  history.replaceState(null, "", url.toString());
});

$share.addEventListener("click", async () => {
  const code = currentRoomCode();
  if (!code) {
    showToast("Join a room first", "warning");
    return;
  }
  const url = new URL(location.href);
  url.searchParams.set("room", code);
  await navigator.clipboard.writeText(url.toString());
  showToast("Share link copied!", "success");
});

$deleteRoom.addEventListener("click", async () => {
  const code = currentRoomCode();

  if (!code) {
    if (!confirm("Clear ALL local cached rooms on this device?")) return;
    localStorage.removeItem("bhq-rooms-v1");
    location.reload();
    return;
  }

  if (!confirm(`Delete room "${code}" for everyone?\n\nThis will remove the room for everyone, not just you.`)) return;

  try {
    await deleteRoom(code);
    showToast(`Room "${code}" deleted`, "success");
  } catch (e) {
    console.error(e);
    showToast("Failed to delete room", "warning");
  }

  const url = new URL(location.href);
  url.searchParams.delete("room");
  location.href = url.toString();
});

const guideJsonUrl = (noCache = false) => {
  const u = new URL("data/guide.json", location.href);
  if (noCache) u.searchParams.set("ts", Date.now());
  return u.toString();
};

function extractDateFromUrl(url) {
  const match = url.match(/(\d{1,2})\.(\d{1,2})\.(\d{2})/);
  if (match) {
    const month = parseInt(match[1]);
    const day = parseInt(match[2]);
    const year = 2000 + parseInt(match[3]);
    const date = new Date(year, month - 1, day);
    return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  }
  return null;
}

function updateGuideLink(meta) {
  var u = (meta && meta.url) ? String(meta.url) : "";
  updatePdfLink(u);
  var dateStr = u ? extractDateFromUrl(u) : null;
  updateSermonDate(dateStr);
}

async function loadGuideJson(noCache = false) {
  $status.textContent = "Loadingâ€¦";
  try {
    const res = await fetch(guideJsonUrl(noCache), { cache: noCache ? "no-store" : "default" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    updateGuideLink(data);
    const next = [
      ...(data.questions || []).map(q => ({
        type: "question",
        text: q,
        status: "active",
        source: "pdf"
      })),
      ...(data.sections || []).map(s => ({
        type: "section",
        title: s.title,
        text: s.body,
        status: "active",
        source: "pdf"
      }))
    ];
    renderCards(next);
    autoSave();
    $status.textContent = `Loaded: ${next.length} cards`;
    showToast(`Loaded ${next.length} cards`, "success");
  } catch (e) {
    console.error(e);
    $status.textContent = "Failed to load";
    showToast("Failed to load discussion guide", "warning");
  }
}

$loadLatest.addEventListener("click", () => {
  if (!confirm("Load Latest Sermon will replace the current board.\n\nAny changes will be overwritten. Continue?")) return;
  loadGuideJson(false);
});

$emptyLoadBtn.addEventListener("click", () => {
  loadGuideJson(false);
});

$refresh.addEventListener("click", () => {
  if (!confirm("Refresh will re-read and overwrite the current guide.\n\nAny changes will be overwritten. Continue?")) return;
  loadGuideJson(true);
});

function escapeHtml(s) {
  return s.replace(/[&<>"']/g, m => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    "\"": "&quot;",
    "'": "&#039;"
  }[m]));
}
```

  </script>
</body>
</html>
